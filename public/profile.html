<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - CEREBREXIA'25</title>

    <link rel="manifest" href="/manifest.json"> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- Base and Reset Styles --- */
        :root {
            --primary-glow-color: #50c8ff;
            --secondary-glow-color: #ff00ff;
            --dark-bg: #0a0e1a;
            --medium-bg: #10182c;
        }
        * { box-sizing: border-box; }
        html { background-color: #0d001f; scroll-behavior: smooth; }
        body, html {
            margin: 0; padding: 0; min-height: 100vh;
            font-family: 'Kanit', sans-serif;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        body { background-color: transparent; position: relative; }

        /* --- Header Styles --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: transparent; z-index: 1000;
            transition: background-color 0.4s ease, backdrop-filter 0.4s ease, transform 0.3s ease;
            padding: 10px 15px; display: flex; flex-direction: row;
            align-items: center; justify-content: space-between;
        }
        header.scrolled {
            background: rgba(13, 0, 31, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        header.hidden { transform: translateY(-100%); }
        header.visible { transform: translateY(0); }
        .logo { height: 80px; user-select: none; text-decoration: none; z-index: 1001; display: flex; align-items: center; }
        .logo img { height: 100%; width: auto; }
        .new-menu-toggle-button { background: transparent; border: none; color: #fff; cursor: pointer; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1202; }
        .new-menu-toggle-button .icon-bar { display: block; width: 30px; height: 3px; background-color: #fff; margin: 6px 0; transition: all 0.3s ease; border-radius: 1px; }
        .new-menu-toggle-button:hover .icon-bar { background-color: var(--secondary-glow-color); }
        .new-menu-toggle-button.open .icon-bar:nth-child(1) { transform: translateY(9px) rotate(45deg); }
        .new-menu-toggle-button.open .icon-bar:nth-child(2) { opacity: 0; }
        .new-menu-toggle-button.open .icon-bar:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }
        #fullScreenNav {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 0, 31, 0.97); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 1200; display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s linear 0.5s;
        }
        #fullScreenNav.active { opacity: 1; visibility: visible; transition: opacity 0.5s ease, visibility 0s linear 0s; }
        #fullScreenNav ul { list-style: none; padding: 0; text-align: center; }
        #fullScreenNav li { margin: 20px 0; }
        #fullScreenNav a { font-family: 'Exo', sans-serif; font-weight: 700; font-size: clamp(2rem, 5vw, 3rem); color: #fff; text-decoration: none; padding: 10px 25px; position: relative; transition: color 0.4s ease, transform 0.4s ease; text-transform: uppercase; }
        #fullScreenNav a:hover, #fullScreenNav a:focus { color: #ffdd57; transform: translateY(-5px) scale(1.05); }
        #fullScreenNav a.active-nav-link { color: #ffd700; text-shadow: 0 0 8px #ffd700, 0 0 15px rgba(255, 215, 0, 0.7); }
        #fullScreenNav .nav-close-btn { position: absolute; top: 25px; right: 25px; background: transparent; color: #fff; border: none; font-size: 2.5rem; cursor: pointer; z-index: 1201; transition: all 0.3s ease; }
        #fullScreenNav .nav-close-btn:hover { color: var(--secondary-glow-color); transform: rotate(90deg) scale(1.1); }
        
        main.container { max-width: 1200px; margin: 120px auto 60px; padding: 20px; min-height: 60vh;}
        h1.page-title { font-size: 3rem; color: #fff; text-align: center; margin-bottom: 40px; font-family: 'Orbitron', sans-serif; text-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 15px var(--primary-glow-color); }
        h2.section-title { font-family: 'Exo', sans-serif; font-size: 1.8rem; color: var(--secondary-glow-color); margin-top: 40px; margin-bottom: 20px; border-bottom: 2px solid rgba(255, 153, 255, 0.3); padding-bottom: 10px; }
        
        /* --- Login and Profile Form Styles --- */
        .login-view, .profile-form-view {
            text-align: center; padding: 50px 20px; background: rgba(255,0,255,0.05);
            border: 1px solid rgba(255,0,255,0.3); border-radius: 15px;
        }
        .google-signin-btn {
            background-color: #fff; color: #1f2937; font-family: 'Kanit', sans-serif;
            font-weight: 600; font-size: 1.2rem; padding: 12px 25px; border-radius: 10px;
            border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 15px;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }
        .google-signin-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(255, 255, 255, 0.4); }
        .google-signin-btn img { height: 24px; width: 24px; }
        .profile-form .form-group { margin-bottom: 18px; text-align: left; }
        .profile-form label { display: block; margin-bottom: 6px; font-weight: 500; color: #ff99ff; }
        .profile-form input {
            width: 100%; padding: 10px 12px; background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; color: #e0e0e0;
            font-family: 'Kanit', sans-serif; transition: all 0.3s;
        }
        .profile-form input:focus { outline: none; border-color: var(--secondary-glow-color); box-shadow: 0 0 10px rgba(255, 0, 255, 0.5); }
        .profile-form-btn {
            width: 100%; padding: 12px; background: linear-gradient(45deg, #e600e6, #7c16cb);
            color: white; border: none; border-radius: 8px; font-family: 'Exo', sans-serif;
            font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;
            margin-top: 10px; text-transform: uppercase;
        }
        .profile-form-btn:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(230,0,230,0.6); }

        /* --- Dashboard Styles --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 30px; }
        .dashboard-card {
            background: rgba(255,0,255,0.08); border: 1px solid rgba(255,0,255,0.3);
            border-radius: 15px; padding: 25px; box-shadow: 0 0 20px rgba(255,0,255,0.1);
            transition: all 0.3s ease;
        }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 5px 25px rgba(255,0,255,0.2); }
        
        .profile-card { grid-column: span 12 / span 12; }
        .fest-pass-card { grid-column: span 12 / span 12; }
        .events-card { grid-column: span 12 / span 12; }
        .teams-card { grid-column: span 12 / span 12; }
        .achievements-card { grid-column: span 12 / span 12; }
        .notifications-card { grid-column: span 12 / span 12; }


        .user-info { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .user-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary-glow-color); }
        .user-details h3 { font-family: 'Exo', sans-serif; font-size: 1.5rem; margin: 0; color: #fff; }
        .user-details p { margin: 5px 0 0; color: #ccc; font-size: 0.9rem; }
        
        .cerebreia-id-display {
            background: rgba(0, 255, 255, 0.1); border: 1px solid var(--primary-glow-color);
            padding: 15px; border-radius: 10px; text-align: center; margin: 20px 0;
        }
        .cerebreia-id-display .id-label { font-size: 0.9rem; color: var(--primary-glow-color); letter-spacing: 1px; }
        .cerebreia-id-display .id-code {
            font-family: 'Share Tech Mono', monospace; font-size: 1.6rem; color: #fff;
            letter-spacing: 2px; margin: 5px 0; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .copy-btn { background: none; border: none; color: var(--primary-glow-color); cursor: pointer; font-size: 1rem; transition: color 0.3s;}
        .copy-btn:hover { color: #fff; }

        .fest-pass-content .qr-container { text-align: center; }
        .fest-pass-content .qr-container img { width: 180px; height: 180px; margin: 15px auto; border: 5px solid white; border-radius: 10px; background: white; }
        .fest-pass-content .payment-details p { font-size: 0.9rem; margin: 5px 0; }
        .fest-pass-content .payment-details strong { color: var(--secondary-glow-color); }
        
        .action-btn {
            display: block; width: 100%; text-align: center; padding: 12px;
            color: white; border-radius: 8px; text-decoration: none;
            font-weight: 700; transition: all 0.3s ease; margin-top: 20px;
            text-transform: uppercase;
        }
        .register-fest-btn { background: linear-gradient(45deg, #00c6ff, #0072ff); }
        .register-fest-btn:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(0, 198, 255, 0.6); }
        .explore-events-btn { background: linear-gradient(45deg, #f857a6, #ff5858); }
        .explore-events-btn:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(248, 87, 166, 0.6); }
        .download-pass-btn { background: linear-gradient(45deg, #4CAF50, #8BC34A); }
        .download-pass-btn:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(76, 175, 80, 0.6); }


        .registered-events-list { list-style: none; padding: 0; margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .event-item {
            display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2);
            padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary-glow-color);
            position: relative; /* For calendar button positioning */
        }
        .event-item .icon { font-size: 1.5rem; color: var(--primary-glow-color); width: 30px; text-align: center; }
        .event-info h4 { margin: 0; font-size: 1.1rem; color: #fff; }
        .event-info p { margin: 2px 0 0; font-size: 0.85rem; }
        .add-to-calendar-btn {
            background: none; border: none; color: #f9c74f; font-size: 1.2rem; cursor: pointer;
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            transition: color 0.3s ease;
        }
        .add-to-calendar-btn:hover { color: #fff; }


        .team-members-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 15px; }
        .team-member-card { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid rgba(0, 255, 255, 0.2); }
        .team-member-card img { width: 120px; height: 120px; margin: 0 auto 10px; border: 3px solid white; border-radius: 8px; background: white; object-fit: cover; }
        .team-member-card h5 { margin: 5px 0; font-size: 1.1rem; color: #fff; font-family: 'Exo', sans-serif; }
        .team-member-card p { font-family: 'Share Tech Mono', monospace; color: var(--primary-glow-color); font-size: 0.9rem; }
        .team-member-list { list-style: none; padding: 0; margin-top: 10px; font-size: 0.9rem; color: #ccc;}
        .team-member-list li { margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .team-member-list li i { font-size: 0.8rem; color: #50c8ff;}


        .achievement-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;}
        .achievement-item {
            text-align: center; padding: 10px; background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 10px;
            min-width: 100px;
        }
        .achievement-item i { font-size: 2.5rem; color: #ffdd57; text-shadow: 0 0 8px #ffdd57; }
        .achievement-item p { font-size: 0.85rem; margin-top: 5px; color: #e0e0e0; }

        .notification-list { list-style: none; padding: 0; margin-top: 15px; }
        .notification-item {
            background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid var(--secondary-glow-color);
        }
        .notification-item strong { color: #fff; font-size: 1.1rem; }
        .notification-item p { font-size: 0.9rem; color: #ccc; margin-top: 5px; }
        .notification-item .timestamp { font-size: 0.75rem; color: #888; text-align: right; margin-top: 5px; }


        .logout-btn {
            position: absolute; top: 100px; right: 30px;
            background: rgba(255, 0, 0, 0.2); border: 1px solid #ff4d4d; color: #ff4d4d;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            z-index: 999; /* Ensure it's above other elements */
        }
        .logout-btn:hover { background: #ff4d4d; color: #fff; }
        .edit-profile-btn {
            position: absolute; top: 100px; right: 160px; /* Adjusted position for desktop */
            background: rgba(0, 198, 255, 0.2); border: 1px solid #00c6ff; color: #00c6ff;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            z-index: 999;
        }
        .edit-profile-btn:hover { background: #00c6ff; color: #fff; }

        .hidden { display: none !important; }

        /* --- Skeleton Loader Styles --- */
        .skeleton-loader {
            background-color: #2a2a40;
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
            margin-bottom: 10px;
        }
        .skeleton-loader.text {
            height: 1em;
            width: 80%;
        }
        .skeleton-loader.avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }
        .skeleton-loader.square {
            width: 100%;
            height: 150px; /* Adjust height as needed for cards */
        }
        .skeleton-loader.qr {
            width: 180px;
            height: 180px;
            margin: 15px auto;
            border-radius: 10px;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* --- Footer Styles --- */
        .site-footer { background-color: #0A0E1A; color: #b0b0b0; padding: 60px 20px 30px; font-family: 'Kanit', sans-serif; margin-top: 60px; border-top: 4px solid #3a3a5e; }
        .footer-container-new { max-width: 1300px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 45px; text-align: left; }
        .footer-section-new h3 { font-family: 'Exo', sans-serif; font-size: 1.7em; font-weight: 600; color: #f9c74f; margin-bottom: 25px; position: relative; padding-bottom: 10px; }
        .footer-section-new h3::after { content: ''; position: absolute; bottom: 0; left: 0; width: 50px; height: 3px; background-color: #f9c74f; }
        .footer-about p { line-height: 1.8; font-size: 1.05rem; }
        .footer-social-icons-new { margin-top: 20px; display: flex; gap: 15px; list-style: none; padding: 0; justify-content: flex-start; }
        .footer-social-icons-new a { display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; border-radius: 50%; font-size: 1.7rem; transition: transform 0.3s ease, color 0.3s ease; text-decoration: none; }
        .footer-social-icons-new a:hover { transform: scale(1.15) translateY(-4px); }
        .footer-social-icons-new .fa-instagram { color: #E1306C; }
        .footer-social-icons-new .fa-instagram:hover { color: #fff; background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); }
        .footer-social-icons-new .fa-whatsapp { color: #25D366; }
        .footer-social-icons-new .fa-whatsapp:hover { color: #fff; background-color: #25D366; }
        .footer-social-icons-new .fa-youtube { color: #FF0000; }
        .footer-social-icons-new .fa-youtube:hover { color: #fff; background-color: #FF0000; }
        .footer-links-list { list-style: none; padding: 0; margin: 0; }
        .footer-links-list li { margin-bottom: 14px; }
        .footer-links-list li a { color: #b0b0b0; text-decoration: none; transition: color 0.3s ease, padding-left 0.3s ease; font-size: 1.05rem; cursor: pointer; }
        .footer-links-list li a:hover { color: #f9c74f; padding-left: 10px; }
        .footer-contact-info p { margin-bottom: 15px; display: flex; align-items: center; font-size: 1.05rem; }
        .footer-contact-info p i { color: #f9c74f; margin-right: 15px; font-size: 1.2rem; width: 20px; }
        .footer-contact-info p a { color: #b0b0b0; text-decoration: none; transition: color 0.3s ease; }
        .footer-contact-info p a:hover { color: #f9c74f; }
        .footer-bottom-new { text-align: center; margin-top: 40px; padding-top: 25px; border-top: 1px solid #3a3a5e; font-size: 1rem; color: #a0a0a0; }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13, 0, 31, 0.8); backdrop-filter: blur(5px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-container { background: #10182c; border: 1px solid #607080; border-radius: 15px; padding: 30px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform 0.4s ease; }
        .modal-overlay.active .modal-container { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #fff; font-size: 2rem; cursor: pointer; line-height: 1; transition: color 0.3s, transform 0.3s; }
        .modal-close-btn:hover { color: var(--secondary-glow-color); transform: rotate(90deg); }
        .modal-title { font-family: 'Exo', sans-serif; font-size: 2rem; color: var(--secondary-glow-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(255, 153, 255, 0.3); }
        .modal-content { line-height: 1.7; color: #e0e0e0; }

        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #loading-overlay.active {
            opacity: 1; visibility: visible;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (min-width: 768px) {
            .profile-card { grid-column: span 5 / span 5; }
            .fest-pass-card { grid-column: span 7 / span 7; }
            .achievements-card { grid-column: span 6 / span 6; }
            .notifications-card { grid-column: span 6 / span 6; }
        }
        @media (max-width: 768px) { 
            h1.page-title { font-size: 2.5rem; } 
            .dashboard-grid { grid-template-columns: 1fr; }
            .profile-card, .fest-pass-card, .events-card, .teams-card, .achievements-card, .notifications-card { grid-column: span 1 / span 1; }
        }
        @media (max-width: 600px) { 
            .logo { height: 70px; } 
            header { padding: 10px 15px;} 
            main.container { margin-top: 90px; } 
            h1.page-title { font-size: 2rem; } 
            .user-info { flex-direction: column; text-align: center; } 
            /* Adjust button positioning for smaller screens to prevent overlap with title */
            .logout-btn { top: 120px; right: 15px; } 
            .edit-profile-btn { top: 120px; right: 110px; /* Adjust as needed for spacing */ }
        }
    </style>
</head>
<body>

<header class="visible">
    <a href="index.html" class="logo">
        <img src="https://storage.googleapis.com/cerebrexia/WEBSITE%20LOGO.png" alt="Cerebrexia Logo">
    </a>
    <div class="header-controls">
        <button class="new-menu-toggle-button" id="newMenuToggleButton" aria-label="Open navigation menu">
            <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
        </button>
    </div>
</header>

<div id="fullScreenNav">
    <button class="nav-close-btn" id="navCloseButton" aria-label="Close navigation menu">×</button>
    <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="events.html">EVENTS</a></li>
        <li><a href="pronite.html">PRONITES</a></li>
        <li><a href="register.html">REGISTER</a></li>
        <li><a href="merch.html">MERCHANDISE</a></li>
        <li><a href="accomodation.html">ACCOMMODATION</a></li>
        <li><a href="schedule.html">SCHEDULE</a></li>
        <li><a href="profile.html" class="active-nav-link">PROFILE</a></li>
    </ul>
</div>

<main class="container">
    <h1 class="page-title" data-aos="fade-up">MY PROFILE</h1>

    <div id="login-view" class="login-view" data-aos="fade-up" data-aos-delay="100">
        <h2 class="section-title">Access Your Dashboard</h2>
        <p class="mb-6 text-gray-300">Sign in to manage your registrations, view your fest pass, and more.</p>
        <button id="google-signin-btn" class="google-signin-btn">
            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
            <span>Sign in with Google</span>
        </button>
    </div>

    <div id="profile-form-view" class="profile-form-view hidden" data-aos="fade-up" data-aos-delay="100">
        <h2 class="section-title" id="profile-form-title">Complete Your Profile</h2>
        <p class="mb-6 text-gray-300" id="profile-form-description">Welcome to CEREBREXIA'25! We need a few more details to create your profile.</p>
        <form id="profile-form" class="profile-form">
            <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="fullName" placeholder="Enter your full name" required>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="phone">Contact Number (WhatsApp)</label>
                    <input type="tel" id="phone" name="phone" placeholder="+91 XXXXXXXXXX" required>
                </div>
                <div class="form-group">
                    <label for="college">College Name</label>
                    <input type="text" id="college" name="college" placeholder="Enter your college name" required>
                </div>
            </div>
            <button type="submit" class="profile-form-btn" id="profile-form-submit-btn">Save & Get My CEREBREIA ID</button>
            <button type="button" class="profile-form-btn mt-2 bg-gray-600 hover:bg-gray-700" id="cancel-edit-btn" style="background: linear-gradient(45deg, #4a5568, #2d3748); display: none;">Cancel</button>
        </form>
    </div>

    <div id="dashboard-view" class="hidden" data-aos="fade-up" data-aos-delay="100">
        <button id="logout-btn" class="logout-btn" aria-label="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <button id="edit-profile-btn" class="edit-profile-btn" aria-label="Edit Profile"><i class="fas fa-edit"></i> Edit Profile</button>
        <div class="dashboard-grid">
            
            <div class="profile-card dashboard-card">
                <div class="user-info">
                    <img id="user-avatar" src="https://placehold.co/80x80/0d001f/ffffff?text=U" alt="User Avatar" class="user-avatar">
                    <div class="user-details">
                        <h3 id="user-name">Loading...</h3>
                        <p id="user-email">loading@example.com</p>
                        <p id="user-greeting" class="text-sm text-gray-400 mt-1">Hello there!</p> </div>
                </div>
                <div class="cerebreia-id-display">
                    <div class="id-label">YOUR UNIQUE CEREBREIA ID</div>
                    <div class="id-code">
                        <i class="fas fa-barcode"></i>
                        <span id="cerebreia-id">CRB25-XXXXXX</span>
                        <button class="copy-btn" id="copy-id-btn" title="Copy ID" aria-label="Copy Cerebrexia ID"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
            </div>

            <div class="fest-pass-card dashboard-card">
                <h2 class="section-title" style="margin-top: 0;">Fest Pass</h2>
                <div id="fest-pass-content" class="fest-pass-content">
                    <div class="qr-container">
                        <div class="skeleton-loader qr"></div>
                        <div class="skeleton-loader text w-3/4 mx-auto"></div>
                        <div class="skeleton-loader text w-1/2 mx-auto mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="events-card dashboard-card">
                <h2 class="section-title" style="margin-top: 0;">My Registered Events</h2>
                <ul id="registered-events-list" class="registered-events-list">
                    <li class="event-item skeleton-loader square"></li>
                    <li class="event-item skeleton-loader square"></li>
                </ul>
                    <a href="events.html" class="action-btn explore-events-btn mt-4">
                        <i class="fas fa-plus-circle"></i> Explore & Register for More Events
                    </a>
            </div>
            
            <div id="teams-card" class="teams-card dashboard-card hidden">
                    <h2 class="section-title" style="margin-top: 0;">My Team Registrations</h2>
                    <div id="team-members-container" class="team-members-grid">
                        <div class="team-member-card skeleton-loader square"></div>
                        <div class="team-member-card skeleton-loader square"></div>
                    </div>
            </div>

            <div id="achievements-card" class="achievements-card dashboard-card">
                <h2 class="section-title" style="margin-top: 0;">My Achievements</h2>
                <div id="achievement-display" class="achievement-grid">
                    <div class="achievement-item skeleton-loader square w-24 h-24"></div>
                    <div class="achievement-item skeleton-loader square w-24 h-24"></div>
                </div>
            </div>

            <div id="notifications-card" class="notifications-card dashboard-card">
                <h2 class="section-title" style="margin-top: 0;">Notifications</h2>
                <ul id="notification-list" class="notification-list">
                    <li class="notification-item skeleton-loader square h-20"></li>
                    <li class="notification-item skeleton-loader square h-20"></li>
                </ul>
            </div>
        </div>
    </div>
</main>

<footer class="site-footer">
    <div class="footer-container-new">
        <div class="footer-section-new footer-about">
            <h3>About CEREBREXIA</h3>
            <p>The electrifying annual fest of IGIMS Patna! A confluence of talent, culture, and unforgettable moments. Join us to celebrate creativity and innovation.</p>
            <ul class="footer-social-icons-new">
                <li><a href="https://www.instagram.com/igimsfest/" target="_blank" rel="noopener noreferrer" aria-label="Instagram" title="Instagram"><i class="fab fa-instagram"></i></a></li>
                <li><a href="https://whatsapp.com/channel/0029VbA0P20HbFV2ke5rlR2G" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp Channel" title="WhatsApp Channel"><i class="fab fa-whatsapp"></i></a></li>
                <li><a href="https://www.youtube.com/@CerebrexiaIGIMS" target="_blank" rel="noopener noreferrer" aria-label="Youtube Channel" title="Youtube Channel"><i class="fab fa-youtube"></i></a></li>
            </ul>
        </div>
        <div class="footer-section-new">
            <h3>Useful Links</h3>
            <ul class="footer-links-list">
                <li><a href="index.html">Home</a></li>
                <li><a href="events.html">Events</a></li>
                <li><a href="schedule.html">Schedule</a></li>
                <li><a href="register.html">Basic Registration</a></li>
            </ul>
        </div>
        <div class="footer-section-new">
            <h3>Policies</h3>
            <ul class="footer-links-list">
                <li><a id="privacy-policy-link" aria-label="Privacy Policy">Privacy Policy</a></li>
                <li><a id="terms-conditions-link" aria-label="Terms and Conditions">Terms & Conditions</a></li>
            </ul>
        </div>
        <div class="footer-section-new">
            <h3>Contact Info</h3>
            <div class="footer-contact-info">
                <p><i class="fas fa-map-marker-alt"></i>IGIMS Patna, Sheikhpura, Bihar</p>
                <p><i class="fas fa-envelope"></i><a href="mailto:info@cerebrexia25.com">info@cerebrexia25.com</a></p>
                <p><i class="fas fa-phone"></i><a href="tel:+917541054474">+91 75410 54474</a></p>    
            </div>
        </div>
    </div>
    <div class="footer-bottom-new">
        <p>© 2025 CEREBREXIA'25 - IGIMS Patna. All Rights Reserved.</p>
    </div>
</footer>

<div id="policy-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-container">
        <button id="modal-close-button" class="modal-close-btn" aria-label="Close modal">×</button>
        <h2 id="modal-title" class="modal-title">Policy Title</h2>
        <div id="modal-content" class="modal-content"><p>Policy content will be loaded here...</p></div>
    </div>
</div>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <span>Loading...</span>
</div>

<div id="toast-notification" role="alert" aria-live="polite" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: white; padding: 10px 20px; border-radius: 8px; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s;"></div>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // Import getAnalytics
    
    // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
    // __app_id: The current app ID for Firestore paths.
    // __firebase_config: Firebase configuration object.
    // __initial_auth_token: Custom Firebase auth token for initial sign-in.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
        apiKey: "AIzaSyBOWumY95hdMt2uOvmJEk5WG0GhdqUHUNc",
        authDomain: "cerebrexia-ee068.firebaseapp.com",
        projectId: "cerebrexia-ee068",
        storageBucket: "cerebrexia-ee068.firebasestorage.app",
        messagingSenderId: "328864114758",
        appId: "1:328864114758:web:108968f6576b6967f14247",
        measurementId: "G-6Z6EP1ZTEJ"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app); // Initialize Analytics
    
    let currentUserId = null; // To store the authenticated user's ID
    let currentUserProfile = null; // To store the fetched user profile data

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }

    // --- AOS and Header Scroll Logic ---
    AOS.init({ once: true, mirror: false });
    let lastScrollTop = 0;
    const header = document.querySelector('header');
    window.addEventListener('scroll', () => {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        header.classList.toggle('scrolled', scrollTop > 50);
        if (scrollTop > lastScrollTop && scrollTop > header.offsetHeight) {
            header.classList.add('hidden');
            header.classList.remove('visible');
        } else {
            header.classList.remove('hidden');
            header.classList.add('visible');
        }
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    }, { passive: true });

    // --- Navigation Menu Logic ---
    const newMenuToggleButton = document.getElementById('newMenuToggleButton');
    const fullScreenNav = document.getElementById('fullScreenNav');
    const navCloseButton = document.getElementById('navCloseButton');
    const toggleNav = () => {
        newMenuToggleButton.classList.toggle('open');
        fullScreenNav.classList.toggle('active');
        document.body.style.overflow = fullScreenNav.classList.contains('active') ? 'hidden' : '';
    };
    newMenuToggleButton.addEventListener('click', toggleNav);
    navCloseButton.addEventListener('click', toggleNav);
    
    // --- Toast Notification ---
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.style.opacity = 1;
        toast.style.visibility = 'visible';
        setTimeout(() => {
            toast.style.opacity = 0;
            toast.style.visibility = 'hidden';
        }, 3000);
    }

    // --- Loading Overlay Functions ---
    const loadingOverlay = document.getElementById('loading-overlay');
    function showLoading(message = 'Loading...') {
        loadingOverlay.querySelector('span').textContent = message;
        loadingOverlay.classList.add('active');
    }
    function hideLoading() {
        loadingOverlay.classList.remove('active');
    }

    // --- DOM Elements ---
    const loginView = document.getElementById('login-view');
    const profileFormView = document.getElementById('profile-form-view');
    const dashboardView = document.getElementById('dashboard-view');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const editProfileBtn = document.getElementById('edit-profile-btn'); // New: Edit Profile Button
    const profileForm = document.getElementById('profile-form');
    const fullNameInput = document.getElementById('fullName');
    const phoneInput = document.getElementById('phone');
    const collegeInput = document.getElementById('college');
    const profileFormTitle = document.getElementById('profile-form-title');
    const profileFormDescription = document.getElementById('profile-form-description');
    const profileFormSubmitBtn = document.getElementById('profile-form-submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn'); // New: Cancel Edit Button
    const userGreetingElement = document.getElementById('user-greeting'); // New: User Greeting Element

    // --- FIREBASE AUTH & FIRESTORE LOGIC ---
    
    // Listen for Firebase Auth state changes
    onAuthStateChanged(auth, async user => {
        if (user) {
            currentUserId = user.uid;
            console.log("User authenticated:", user.uid);
            showLoading('Fetching profile...');
            await fetchUserProfile(user);
            hideLoading();
        } else {
            currentUserId = null;
            currentUserProfile = null;
            console.log("No user authenticated. Attempting anonymous sign-in or custom token sign-in.");
            showLoading('Connecting...');
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                showToast("Failed to connect. Please try again.");
                showView('login'); // Show login if even anonymous fails
            } finally {
                hideLoading();
            }
        }
    });

    /**
     * Fetches the user's profile from Firestore.
     * If profile exists, populates dashboard. If not, shows profile form.
     * @param {firebase.User} user - The authenticated Firebase user object.
     */
    async function fetchUserProfile(user) {
        // Updated path for profile
        const profileDocRef = doc(db, 'users', user.uid);    
        try {
            const profileDocSnap = await getDoc(profileDocRef);
            if (profileDocSnap.exists()) {
                console.log("User profile found.");
                currentUserProfile = profileDocSnap.data();
                showView('dashboard');
                populateDashboard(user.uid, currentUserProfile);
            } else {
                console.log("User profile not found. Showing profile form.");
                showView('form');
                // Pre-fill email if available from Google login
                // (Note: Your form doesn't have an email field, but keeping for general practice)
                fullNameInput.value = user.displayName || ''; // Pre-fill name from Google
                // No specific email field in form, so not pre-filling.
                profileFormTitle.textContent = 'Complete Your Profile';
                profileFormDescription.textContent = "Welcome to CEREBREXIA'25! We need a few more details to create your profile.";
                profileFormSubmitBtn.textContent = 'Save & Get My CEREBREIA ID';
                cancelEditBtn.style.display = 'none';
            }
        } catch (error) {
            console.error("Error fetching user profile:", error);
            showToast("Could not fetch your profile. Please refresh.");
            showView('login'); // Fallback to login if fetching profile fails
        }
    }

    /**
     * Handles Google Sign-In.
     */
    async function handleSignIn() {
        const provider = new GoogleAuthProvider();
        showLoading('Signing in with Google...');
        try {
            await signInWithPopup(auth, provider);
            // onAuthStateChanged listener will handle the rest
        } catch (error) {
            console.error('Error signing in with Google:', error);
            showToast(`Login failed: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    /**
     * Handles user sign-out.
     */
    async function handleSignOut() {
        showLoading('Logging out...');
        try {
            await signOut(auth);
            showToast('Logged out successfully.');
            // onAuthStateChanged listener will handle showing the login view
        } catch (error) {
            console.error('Error signing out:', error);
            showToast('Could not sign out. Please try again.');
        } finally {
            hideLoading();
        }
    }

    // Event listener for profile form submission (create or update)
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showToast("User not found. Please sign in again.");
            return;
        }

        showLoading('Saving profile...');

        let cerebreiaId = currentUserProfile ? currentUserProfile.cerebreia_id : null;
        if (!cerebreiaId) {
            const uniquePart = user.uid.substring(0, 6).toUpperCase();
            cerebreiaId = `CRB25-${uniquePart}`;
        }

        const profileData = {
            uid: user.uid,
            email: user.email,
            full_name: fullNameInput.value,
            phone: phoneInput.value,
            college: collegeInput.value,
            avatar_url: user.photoURL || `https://placehold.co/80x80/0d001f/ffffff?text=${user.email ? user.email.charAt(0).toUpperCase() : 'U'}`,
            cerebreia_id: cerebreiaId,
            updated_at: Timestamp.now() // Add updated_at timestamp
        };

        // If creating for the first time, add created_at
        if (!currentUserProfile) {
            profileData.created_at = Timestamp.now();
            profileData.achievements = ['registered_user']; // Initial achievement
        } else {
            // Preserve existing achievements if updating
            profileData.achievements = currentUserProfile.achievements || [];
        }


        // Updated path for profile
        const profileDocRef = doc(db, 'users', user.uid);
        try {
            await setDoc(profileDocRef, profileData, { merge: true }); // Use merge to avoid overwriting other fields
            showToast('Profile saved successfully!');
            await fetchUserProfile(user); // Re-fetch to populate dashboard
        } catch (error) {
            console.error('Error saving profile:', error);
            showToast('Could not save your profile. Please try again.');
        } finally {
            hideLoading();
        }
    });

    // New: Edit Profile Button Handler
    editProfileBtn.addEventListener('click', () => {
        if (currentUserProfile) {
            fullNameInput.value = currentUserProfile.full_name || '';
            phoneInput.value = currentUserProfile.phone || '';
            collegeInput.value = currentUserProfile.college || '';
            profileFormTitle.textContent = 'Edit Your Profile';
            profileFormDescription.textContent = "Update your details below.";
            profileFormSubmitBtn.textContent = 'Save Changes';
            cancelEditBtn.style.display = 'block'; // Show cancel button
            showView('form');
        } else {
            showToast("No profile data to edit. Please create one first.");
        }
    });

    // New: Cancel Edit Button Handler
    cancelEditBtn.addEventListener('click', () => {
        if (currentUserProfile) {
            showView('dashboard'); // Go back to dashboard if editing
        } else {
            showView('login'); // Go back to login if no profile exists
        }
    });


    /**
     * Populates the dashboard with user data, fest pass status, registered events, and team info.
     * @param {string} userId - The current user's UID.
     * @param {object} profile - The user's profile data.
     */
    async function populateDashboard(userId, profile) {
        document.getElementById('user-avatar').src = profile.avatar_url || 'https://placehold.co/80x80/0d001f/ffffff?text=U';
        document.getElementById('user-name').textContent = profile.full_name;
        document.getElementById('user-email').textContent = profile.email;
        document.getElementById('cerebreia-id').textContent = profile.cerebreia_id;
        
        // Personalized Greeting
        userGreetingElement.textContent = `Welcome back, ${profile.full_name.split(' ')[0]}!`;

        // Remove skeleton loaders
        document.getElementById('fest-pass-content').innerHTML = '';
        document.getElementById('registered-events-list').innerHTML = '';
        document.getElementById('team-members-container').innerHTML = '';
        document.getElementById('achievement-display').innerHTML = '';
        document.getElementById('notification-list').innerHTML = '';


        try {
            await Promise.all([
                renderFestPassStatus(userId, profile.cerebreia_id, profile.full_name),
                renderRegisteredEvents(userId),
                renderTeamRegistrations(userId),
                renderAchievements(profile.achievements || []), // Pass achievements from profile
                renderNotifications(userId) // Render notifications
            ]);
        } catch (error) {
            console.error("Error populating dashboard sections:", error);
            showToast("Error loading some dashboard data.");
        }
    }

    /**
     * Renders the fest pass status based on user's registration.
     * @param {string} userId - The current user's UID.
     * @param {string} cerebreiaId - The user's Cerebrexia ID.
     * @param {string} fullName - The user's full name.
     */
    async function renderFestPassStatus(userId, cerebreiaId, fullName) {
        const festPassContainer = document.getElementById('fest-pass-content');
        // Updated collection path for fest registrations
        const festRegCollectionRef = collection(db, 'festRegistrations');    
        const festRegQuery = query(festRegCollectionRef,    
                                    where("userId", "==", userId),
                                    where("paymentStatus", "==", "completed")); // Only show completed ones
        
        try {
            const festRegSnapshot = await getDocs(festRegQuery);

            if (!festRegSnapshot.empty) {
                const festReg = festRegSnapshot.docs[0].data();
                
                // If there are multiple QR codes (for group registrations)
                if (festReg.qrCodesForGroup && festReg.qrCodesForGroup.length > 0) {
                    let qrHtml = '';
                    festReg.qrCodesForGroup.forEach(member => {
                        qrHtml += `
                            <div class="qr-item" style="display: inline-block; width: 48%; max-width: 200px; vertical-align: top; margin: 1%; padding: 15px; background-color: rgba(255,255,255,0.08); border-radius: 10px; text-align: center; border: 1px solid rgba(0,255,255,0.3); box-shadow: 0 0 12px rgba(0,255,255,0.3); box-sizing: border-box;">
                                <img src="${member.qrCodeUrl}" alt="${member.name} QR Code" style="max-width: 100px; height: auto; border: 3px solid #ff00ff; padding: 5px; background: white; border-radius: 8px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;"/>
                                <p style="font-size: 0.95em; color: #fff; font-weight: 600; line-height: 1.3; margin: 0; word-wrap: break-word;">${member.name}${member.isLeader ? ' (Leader)' : ''}</p>
                                <p style="font-size: 0.75em; color: #888; word-break: break-all; margin-top: 5px;">ID: ${member.memberId}</p>
                            </div>
                        `;
                    });

                    festPassContainer.innerHTML = `
                        <p class="text-lg text-green-400 font-bold">Your Fest Pass is Active!</p>
                        <p class="text-sm text-gray-300 mb-4">Click on each QR to download individually, or download all as a PDF.</p>
                        <div class="qr-codes-grid" style="font-size:0; text-align:center; max-width:600px; margin:0 auto; display:block;">
                            ${qrHtml}
                        </div>
                        <div class="payment-details mt-4">
                            <p><strong>Transaction ID:</strong> ${festReg.razorpay_payment_id || 'N/A'}</p>
                            <p><strong>Status:</strong> <span class="font-bold text-green-400 uppercase">${festReg.paymentStatus}</span></p>
                            <p><strong>Enrollment Type:</strong> ${festReg.enrollmentType} (${festReg.numMembers} members)</p>
                        </div>
                        <button id="download-pass-btn" class="action-btn download-pass-btn mt-4" aria-label="Download Fest Pass">
                            <i class="fas fa-download"></i> Download All Fest Passes (PDF)
                        </button>
                    `;
                    document.getElementById('download-pass-btn').addEventListener('click', () => downloadFestPass(festReg.qrCodesForGroup, festReg));
                    
                } else {
                    // Fallback for individual QR code if qrCodesForGroup is not populated for some reason
                    const qrData = `ID: ${cerebreiaId}\nName: ${fullName}\nStatus: ${festReg.paymentStatus}`;
                    festPassContainer.innerHTML = `
                        <div class="qr-container" id="fest-pass-qr-area">
                            <p class="text-lg text-green-400 font-bold">Your Fest Pass is Active!</p>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}" alt="Fest Pass QR Code" id="fest-pass-qr-img">
                            <div class="payment-details">
                                <p><strong>Transaction ID:</strong> ${festReg.razorpay_payment_id || 'N/A'}</p>
                                <p><strong>Status:</strong> <span class="font-bold text-green-400 uppercase">${festReg.paymentStatus}</span></p>
                            </div>
                        </div>
                        <button id="download-pass-btn" class="action-btn download-pass-btn mt-4" aria-label="Download Fest Pass">
                            <i class="fas fa-download"></i> Download Fest Pass
                        </button>
                    `;
                    document.getElementById('download-pass-btn').addEventListener('click', () => downloadFestPass([{ 
                        name: fullName, 
                        memberId: cerebreiaId, 
                        isLeader: true, 
                        qrCodeUrl: document.getElementById('fest-pass-qr-img').src 
                    }], festReg));
                }

                // Award 'fest_registered' achievement if not already present
                if (currentUserProfile && !currentUserProfile.achievements.includes('fest_registered')) {
                    const updatedAchievements = [...currentUserProfile.achievements, 'fest_registered'];
                    await updateProfileAchievements(currentUserId, updatedAchievements);
                }

            } else {
                festPassContainer.innerHTML = `
                    <p class="mb-4 text-lg">You have not completed your basic registration.</p>
                    <a href="register.html" class="action-btn register-fest-btn">
                        <i class="fas fa-ticket-alt"></i> Register for CEREBREXIA'25
                    </a>
                `;
            }
        } catch (error) {
            console.error("Error rendering fest pass status:", error);
            festPassContainer.innerHTML = `<p class="text-red-400">Error loading fest pass status.</p>`;
        }
    }

    /**
     * Renders the list of events the user has registered for.
     * @param {string} userId - The current user's UID.
     */
    async function renderRegisteredEvents(userId) {
        const eventsList = document.getElementById('registered-events-list');
        const iconMap = {
            'Technical': 'fas fa-cogs', 'Cultural': 'fas fa-paint-brush',
            'Gaming': 'fas fa-gamepad', 'Workshop': 'fas fa-chalkboard-teacher',
            'Literary': 'fas fa-book-open', 'Pronite': 'fas fa-music',
            'General': 'fas fa-star'
        };
        
        // Updated collection path for event registrations
        const eventRegCollectionRef = collection(db, 'eventRegistrations');
        const eventsQuery = query(eventRegCollectionRef, where("userId", "==", userId));    

        try {
            const eventsSnapshot = await getDocs(eventsQuery);

            if (!eventsSnapshot.empty) {
                const events = eventsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        // Ensure timestamp is converted correctly
                        registeredAt: data.registeredAt instanceof Timestamp ? data.registeredAt.toDate() : (data.registeredAt ? new Date(data.registeredAt) : new Date(0))
                    };
                });

                events.sort((a, b) => b.registeredAt.getTime() - a.registeredAt.getTime());

                eventsList.innerHTML = events.map(event => {
                    const statusColor = event.paymentStatus.toLowerCase().includes('pending') ? '#f9c74f' : '#50fa7b';
                    const eventDate = event.eventDate ? new Date(event.eventDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Date TBD';
                    const eventTime = event.eventTime || 'Time TBD';

                    return `
                    <li class="event-item">
                        <span class="icon"><i class="${iconMap[event.event_category] || iconMap['General']}"></i></span>
                        <div class="event-info">
                            <h4>${event.eventName}</h4>
                            <p>${eventDate} at ${eventTime}</p>
                            <p style="color: ${statusColor}; text-transform: uppercase;">${event.paymentStatus}</p>
                        </div>
                        <button class="add-to-calendar-btn" data-event='${JSON.stringify({ name: event.eventName, date: event.eventDate, time: event.eventTime, description: event.eventDescription || `Registered for ${event.eventName} at CEREBREXIA'25.` })}' aria-label="Add to Calendar">
                            <i class="fas fa-calendar-plus"></i>
                        </button>
                    </li>`;
                }).join('');

                // Attach event listeners for calendar buttons
                document.querySelectorAll('.add-to-calendar-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const eventData = JSON.parse(e.currentTarget.dataset.event);
                        addToCalendar(eventData);
                    });
                });

                // Award 'event_participant' achievement if user has registered for at least one event
                if (currentUserProfile && events.length > 0 && !currentUserProfile.achievements.includes('event_participant')) {
                    const updatedAchievements = [...currentUserProfile.achievements, 'event_participant'];
                    await updateProfileAchievements(currentUserId, updatedAchievements);
                }

            } else {
                eventsList.innerHTML = `<p class="text-gray-400 col-span-full text-center">You haven't registered for any individual events yet.</p>`;
            }
        } catch (error) {
            console.error("Error rendering registered events:", error);
            eventsList.innerHTML = `<p class="text-red-400 col-span-full text-center">Error loading your registered events.</p>`;
        }
    }

    /**
     * Renders the user's team registrations.
     * Assumes 'eventRegistrations' collection has documents with 'isTeamEvent' and 'teamDetails'
     * @param {string} userId - The current user's UID.
     */
    async function renderTeamRegistrations(userId) {
        const teamsCard = document.getElementById('teams-card');
        const teamMembersContainer = document.getElementById('team-members-container');

        // Query eventRegistrations for team events where the user is the leader
        const teamEventsQuery = query(
            collection(db, 'eventRegistrations'),
            where("userId", "==", userId), // User is the leader (or the one who registered the team)
            where("isTeamEvent", "==", true)
        );
        
        try {
            const teamSnapshot = await getDocs(teamEventsQuery);

            if (!teamSnapshot.empty) {
                teamsCard.classList.remove('hidden');    
                const teamPromises = teamSnapshot.docs.map(async docSnapshot => {
                    const team = docSnapshot.data();
                    const teamName = team.teamName || 'Unnamed Team';
                    const eventName = team.eventName || 'N/A';
                    // The leader's name and avatar should be from the current user's profile
                    const leaderName = currentUserProfile.full_name || team.userName || 'N/A';
                    const leaderAvatar = currentUserProfile.avatar_url || 'https://placehold.co/120x120/0d001f/ffffff?text=Team';

                    let memberListHtml = `<li><i class="fas fa-user-circle"></i> ${leaderName} (You - Leader)</li>`;

                    // If teamDetails are present, iterate through them
                    if (team.teamDetails && team.teamDetails.length > 0) {
                        team.teamDetails.forEach(member => {
                            // Assuming member object has name and optionally college/phone
                            if (member && member.name) {
                                memberListHtml += `<li><i class="fas fa-user-circle"></i> ${member.name}</li>`;
                            }
                        });
                    }

                    return `
                        <div class="team-member-card">
                            <img src="${leaderAvatar}" alt="Team Leader Avatar">
                            <h5>${teamName}</h5>
                            <p>Event: ${eventName}</p>
                            <p>Leader: ${leaderName}</p>
                            <ul class="team-member-list">
                                ${memberListHtml}
                            </ul>
                            <div class="mt-4 text-sm text-gray-400">
                                <p>Team invite/accept/deny features require backend logic and are coming soon!</p>
                            </div>
                        </div>
                    `;
                });
                teamMembersContainer.innerHTML = (await Promise.all(teamPromises)).join('');

                // Award 'team_player' achievement if user is part of at least one team
                if (currentUserProfile && teamSnapshot.size > 0 && !currentUserProfile.achievements.includes('team_player')) {
                    const updatedAchievements = [...currentUserProfile.achievements, 'team_player'];
                    await updateProfileAchievements(currentUserId, updatedAchievements);
                }

            } else {
                teamsCard.classList.add('hidden');    
                teamMembersContainer.innerHTML = '';    
            }
        } catch (error) {
            console.error("Error rendering team registrations:", error);
            teamsCard.classList.add('hidden');    
            teamMembersContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">Error loading your team registrations.</p>`;
        }
    }


    /**
     * Renders the user's achievements/badges.
     * @param {Array<string>} achievements - Array of achievement IDs.
     */
    async function renderAchievements(achievements) {
        const achievementDisplay = document.getElementById('achievement-display');
        const achievementMap = {
            'registered_user': { icon: 'fas fa-user-check', name: 'Registered User' },
            'fest_registered': { icon: 'fas fa-ticket-alt', name: 'Fest Pass Holder' },
            'event_participant': { icon: 'fas fa-trophy', name: 'Event Participant' },
            'team_player': { icon: 'fas fa-users', name: 'Team Player' },
            'early_bird': { icon: 'fas fa-clock', name: 'Early Bird' }, // Example
            'top_scorer': { icon: 'fas fa-medal', name: 'Top Scorer' } // Example
        };

        if (achievements && achievements.length > 0) {
            achievementDisplay.innerHTML = achievements.map(id => {
                const achievement = achievementMap[id];
                if (achievement) {
                    return `
                        <div class="achievement-item">
                            <i class="${achievement.icon}"></i>
                            <p>${achievement.name}</p>
                        </div>
                    `;
                }
                return '';
            }).join('');
        } else {
            achievementDisplay.innerHTML = `<p class="text-gray-400 col-span-full text-center">No achievements yet. Participate in events to earn badges!</p>`;
        }
    }

    /**
     * Updates the user's achievements in Firestore and re-renders the achievements section.
     * @param {string} userId - The current user's UID.
     * @param {Array<string>} newAchievements - The updated array of achievement IDs.
     */
    async function updateProfileAchievements(userId, newAchievements) {
        // Updated path for profile
        const profileDocRef = doc(db, 'users', userId);
        try {
            await setDoc(profileDocRef, { achievements: newAchievements }, { merge: true });
            currentUserProfile.achievements = newAchievements; // Update local state
            renderAchievements(newAchievements); // Re-render achievements
            showToast('New achievement unlocked!');
        } catch (error) {
            console.error('Error updating achievements:', error);
            showToast('Failed to update achievements.');
        }
    }

    /**
     * Renders recent notifications/announcements.
     * Fetches from a public 'announcements' collection.
     * @param {string} userId - The current user's UID (not directly used for public data, but for context).
     */
    async function renderNotifications(userId) {
        const notificationList = document.getElementById('notification-list');
        // Updated collection path for public announcements
        const announcementsCollectionRef = collection(db, 'announcements');    
        // Order by timestamp in descending order
        const announcementsQuery = query(announcementsCollectionRef, orderBy('timestamp', 'desc'));    
        
        try {
            const announcementsSnapshot = await getDocs(announcementsQuery);

            if (!announcementsSnapshot.empty) {
                const announcements = announcementsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        ...data,
                        timestamp: data.timestamp instanceof Timestamp ? data.timestamp.toDate() : (data.timestamp ? new Date(data.timestamp) : new Date(0))
                    };
                });

                notificationList.innerHTML = announcements.map(announcement => {
                    const date = announcement.timestamp.toLocaleDateString();
                    const time = announcement.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <li class="notification-item">
                            <strong>${announcement.title || 'New Announcement'}</strong>
                            <p>${announcement.message || 'No message provided.'}</p>
                            <div class="timestamp">Posted: ${date} ${time}</div>
                        </li>
                    `;
                }).join('');
            } else {
                notificationList.innerHTML = `<p class="text-gray-400 col-span-full text-center">No new notifications.</p>`;
            }
        } catch (error) {
            console.error("Error rendering notifications:", error);
            notificationList.innerHTML = `<p class="text-red-400 col-span-full text-center">Error loading notifications.</p>`;
        }
    }


    // Event listener for copying Cerebrexia ID
    document.getElementById('copy-id-btn').addEventListener('click', () => {
        const idElement = document.getElementById('cerebreia-id');
        const range = document.createRange();
        range.selectNode(idElement);
        window.getSelection().removeAllRanges(); // Clear current selection
        window.getSelection().addRange(range); // Select the text
        try {
            document.execCommand('copy'); // Use document.execCommand for better iframe compatibility
            showToast('CEREBREIA ID Copied!');
        } catch (err) {
            console.error('Failed to copy text: ', err);
            showToast('Failed to copy ID. Please copy manually.');
        }
        window.getSelection().removeAllRanges(); // Deselect the text
    });

    /**
     * Controls which main view is visible.
     * @param {string} viewName - 'login', 'form', or 'dashboard'.
     */
    function showView(viewName) {
        loginView.classList.add('hidden');
        profileFormView.classList.add('hidden');
        dashboardView.classList.add('hidden');
        if (viewName === 'login') loginView.classList.remove('hidden');
        else if (viewName === 'form') profileFormView.classList.remove('hidden');
        else if (viewName === 'dashboard') dashboardView.classList.remove('hidden');
    }

    // --- Modal Logic for Policies ---
    const modalOverlay = document.getElementById('policy-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const modalCloseButton = document.getElementById('modal-close-button');
    const policyContents = {
        'privacy-policy': {    
            title: 'Privacy Policy',    
            content: `
                <h3>Information We Collect</h3>    
                <p>We collect information you provide directly to us when you register for CEREBREXIA'25, including your name, email address, contact number, and college name. We also collect basic profile information (like avatar URL) from your Google account if you sign in using Google.</p>
                <h3>How We Use Your Information</h3>
                <p>Your data is used solely for the purposes of organizing and managing CEREBREXIA'25, including event registrations, fest pass generation, team management, and communication related to the fest. We do not share your personal information with third parties for marketing purposes.</p>
                <h3>Data Security</h3>
                <p>We implement a variety of security measures to maintain the safety of your personal information when you enter, submit, or access your personal information.</p>
                <h3>Your Rights</h3>
                <p>You have the right to access, update, or delete your personal information. Please contact us if you wish to exercise these rights.</p>
            `    
        },
        'terms-conditions': {    
            title: 'Terms & Conditions',    
            content: `
                <h3>User Conduct</h3>    
                <p>By registering for CEREBREXIA'25, you agree to conduct yourself in a respectful and responsible manner. Any form of misconduct, harassment, or violation of event rules will lead to immediate disqualification and potential removal from the premises without refund.</p>
                <h3>Registration and Payments</h3>
                <p>All registrations are subject to availability and successful payment. Registration fees are non-refundable unless otherwise specified for a particular event. CEREBREXIA'25 reserves the right to change event schedules or cancel events due to unforeseen circumstances.</p>
                <h3>Intellectual Property</h3>
                <p>All content, logos, and materials related to CEREBREXIA'25 are the intellectual property of the organizing committee. Unauthorized use, reproduction, or distribution is strictly prohibited.</p>
                <h3>Disclaimer</h3>
                <p>CEREBREXIA'25 and IGIMS Patna are not responsible for any loss, damage, or injury incurred during the fest. Participants are advised to take necessary precautions and are responsible for their own belongings.</p>
            `    
        }
    };
    function openModal(policyType) {
        const policy = policyContents[policyType];
        if (!policy) return;
        modalTitle.textContent = policy.title;
        modalContent.innerHTML = policy.content;
        modalOverlay.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling background
    }
    function closeModal() {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
    document.getElementById('privacy-policy-link').addEventListener('click', () => openModal('privacy-policy'));
    document.getElementById('terms-conditions-link').addEventListener('click', () => openModal('terms-conditions'));
    modalCloseButton.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {    
        // Close modal if clicked outside content
        if (e.target === modalOverlay) closeModal();    
    });

    // --- Download Fest Pass Function ---
    async function downloadFestPass(qrCodesData, festReg) {
        showLoading('Generating Fest Pass PDF...');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm', // Using millimeters for better control
            format: 'a4'
        });

        let yOffset = 10;
        const pageHeight = pdf.internal.pageSize.height;
        const pageWidth = pdf.internal.pageSize.width;
        const cardWidth = 180; // mm
        const cardHeight = 220; // mm
        const xStart = (pageWidth - cardWidth) / 2;


        for (let i = 0; i < qrCodesData.length; i++) {
            const member = qrCodesData[i];
            
            if (i > 0) {
                pdf.addPage();
                yOffset = 10;
            }

            const cardHtml = `
                <div style="font-family: 'Kanit', sans-serif; padding: 15px; text-align: center; border: 2px solid #ff00ff; border-radius: 10px; background-color: #10182c; color: #e0e0e0; width: ${cardWidth}mm; box-sizing: border-box;">
                    <h2 style="color: #50c8ff; font-family: 'Orbitron', sans-serif; margin-bottom: 10px; font-size: 20px;">CEREBREXIA'25 Fest Pass</h2>
                    <img src="https://storage.googleapis.com/cerebrexia/WEBSITE%20LOGO.png" alt="Cerebrexia Logo" style="height: 50px; margin-bottom: 15px;">
                    <p style="font-size: 16px; margin-bottom: 8px;"><strong>Name:</strong> ${member.name}</p>
                    <p style="font-size: 16px; margin-bottom: 15px;"><strong>CEREBREIA ID:</strong> <span style="font-family: 'Share Tech Mono', monospace; color: #ffdd57;">${member.memberId}</span></p>
                    <div style="margin-bottom: 15px;">
                        <img src="${member.qrCodeUrl}" alt="QR Code" style="width: 120px; height: 120px; border: 3px solid white; border-radius: 8px; background: white;">
                    </div>
                    <p style="font-size: 12px; margin-bottom: 5px;"><strong>Transaction ID:</strong> ${festReg.razorpay_payment_id || 'N/A'}</p>
                    <p style="font-size: 12px; color: #50fa7b;"><strong>Status:</strong> ${festReg.paymentStatus.toUpperCase()}</p>
                    <p style="font-size: 10px; margin-top: 15px; color: #aaa;">Valid for CEREBREXIA'25. Please present this QR code at entry.</p>
                </div>
            `;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHtml;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px'; // Off-screen
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv.querySelector('div'), { scale: 3, backgroundColor: null }); // Increased scale for better quality
                const imgData = canvas.toDataURL('image/png');
                
                // Add image to PDF, calculate position to center
                pdf.addImage(imgData, 'PNG', xStart, yOffset, cardWidth, cardHeight);
            } catch (error) {
                console.error(`Error generating canvas for member ${member.name}:`, error);
                showToast(`Failed to generate QR for ${member.name}.`);
            } finally {
                document.body.removeChild(tempDiv);
            }
        }

        try {
            pdf.save(`CEREBREXIA25_FestPasses_${festReg.name.replace(/\s/g, '_')}.pdf`);
            showToast('Fest Passes downloaded successfully!');
        } catch (error) {
            console.error('Error saving PDF:', error);
            showToast('Failed to save Fest Passes PDF. Please try again.');
        } finally {
            hideLoading();
        }
    }


    // --- Add to Calendar Function ---
    function addToCalendar(eventData) {
        const { name, date, time, description } = eventData;
        const eventDateTime = new Date(`${date} ${time}`);
        const start = eventDateTime.toISOString().replace(/-|:|\.\d{3}/g, '');
        const end = new Date(eventDateTime.getTime() + 60 * 60 * 1000).toISOString().replace(/-|:|\.\d{3}/g, ''); // 1 hour duration

        const icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//CEREBREXIA25//NONSGML v1.0//EN',
            'BEGIN:VEVENT',
            `UID:${name}-${start}@cerebrexia25.com`,
            `DTSTAMP:${new Date().toISOString().replace(/-|:|\.\d{3}/g, '')}`,
            `DTSTART:${start}`,
            `DTEND:${end}`,
            `SUMMARY:${name}`,
            `DESCRIPTION:${description}`,
            'END:VEVENT',
            'END:VCALENDAR'
        ].join('\r\n');

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name.replace(/\s/g, '_')}_CEREBREXIA25.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`'${name}' added to calendar download!`);
    }

    // --- Event Listeners for Main Actions ---
    googleSignInBtn.addEventListener('click', handleSignIn);
    logoutBtn.addEventListener('click', handleSignOut);
</script>

<script id="manifest-json" type="application/json">
{
    "name": "CEREBREXIA'25 Profile",
    "short_name": "CEREBREXIA",
    "description": "Your personal dashboard for CEREBREXIA'25 fest.",
    "start_url": "/profile.html",
    "display": "standalone",
    "background_color": "#0d001f",
    "theme_color": "#ff00ff",
    "icons": [
        {
            "src": "https://storage.googleapis.com/cerebrexia/icon-192x192.png",
            "sizes": "192x192",
            "type": "image/png"
        },
        {
            "src": "https://storage.googleapis.com/cerebrexia/icon-512x512.png",
            "sizes": "512x512",
            "type": "image/png"
        }
    ]
}
</script>

<script id="service-worker-js" type="javascript/worker">
const CACHE_NAME = 'cerebrexia-profile-v1';
const urlsToCache = [
    '/',
    '/profile.html',
    '/index.html', // Assuming these are part of your site
    '/events.html',
    '/pronite.html',
    '/register.html',
    '/merch.html',
    '/accomodation.html',
    '/schedule.html',
    'https://cdn.tailwindcss.com',
    'https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css',
    'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css',
    'https://fonts.googleapis.com/css2?family=Exo:wght@400;700;900&display=swap',
    'https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap',
    'https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap',
    'https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap',
    'https://storage.googleapis.com/cerebrexia/WEBSITE%20LOGO.png',
    'https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg',
    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
    // Add Firebase SDKs if you want them cached, but usually not necessary for offline functionality
    // 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js',
    // 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js',
    // 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => {
                console.log('Opened cache');
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request)
            .then((response) => {
                // Cache hit - return response
                if (response) {
                    return response;
                }
                // No cache hit - fetch from network
                return fetch(event.request).then(
                    (response) => {
                        // Check if we received a valid response
                        if (!response || response.status !== 200 || response.type !== 'basic') {
                            return response;
                        }
                        // IMPORTANT: Clone the response. A response is a stream
                        // and can only be consumed once. We must clone it so that
                        // we can consume the stream and the browser can consume it too.
                        const responseToCache = response.clone();

                        caches.open(CACHE_NAME)
                            .then((cache) => {
                                cache.put(event.request, responseToCache);
                            });

                        return response;
                    }
                );
            })
    );
});

self.addEventListener('activate', (event) => {
    const cacheWhitelist = [CACHE_NAME];
    event.waitUntil(
        caches.keys().then((cacheNames) => {
            return Promise.all(
                cacheNames.map((cacheName) => {
                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
});
</script>
</body>
</html>
