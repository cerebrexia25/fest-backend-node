<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEREBREXIA - FINANCE TRACKER</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_isBetween);
        dayjs.extend(window.dayjs_plugin_isSameOrAfter);
        dayjs.extend(window.dayjs_plugin_isSameOrBefore);
    </script>

    <style>
        :root {
            --primary-bg: #f4f7f6; --secondary-bg: #e8ecef; --card-bg: #ffffff;
            --primary-accent: #005A9C; --text-primary: #121212; --text-secondary: #555;
            --border-color: #ddd; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --font-body: 'Roboto', sans-serif; --font-header: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background-color: var(--primary-bg); color: var(--text-primary); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.3s; }
        .overlay.show .modal-content { transform: scale(1); }
        .loader-container { position: fixed; top: 20px; right: 20px; z-index: 2001; background-color: var(--primary-accent); color: white; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s; }
        .loader-container.show { opacity: 1; }
        .mini-loader { border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; width: 100%; }
        
        .app-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .app-header img {
            height: 60px;
            width: 60px;
            border-radius: 8px;
        }
        .app-header h1 {
            font-family: var(--font-header);
            color: var(--primary-accent);
            font-size: 2rem;
        }

        nav { display: flex; flex-wrap: wrap; justify-content: center; background-color: var(--card-bg); border-radius: 10px; margin-bottom: 30px; padding: 10px; box-shadow: var(--shadow); }
        nav button { background: none; border: none; padding: 15px 25px; font-size: 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 8px; transition: background-color .3s, color .3s; display: flex; align-items: center; gap: 8px; }
        nav button:hover { background-color: var(--secondary-bg); }
        nav button.active { background-color: var(--primary-accent); color: white; font-weight: 700; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1, h2, h3 { font-family: var(--font-header); }
        .section-title { font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-accent); display: flex; align-items: center; gap: 12px; }
        .section-subtitle { font-size: 1.5rem; margin-bottom: 15px; color: var(--text-primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-accent); }
        .card h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px; font-weight: 500; }
        .card .amount { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .card .comparison { font-size: 0.9rem; color: var(--text-secondary); }
        .card.income { border-left-color: var(--success-color); }
        .card.expense { border-left-color: var(--danger-color); }
        .card.expected { border-left-color: var(--warning-color); }
        .card.info { border-left-color: var(--info-color); }
        .section-box { background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .form { display: flex; flex-direction: column; gap: 15px; }
        .form input, .form select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .form button { padding: 12px; border: none; border-radius: 5px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color .3s; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .95rem; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 500; color: var(--text-secondary); background-color: #f9fafb; }
        .action-btn { background: var(--primary-accent); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: .9rem; margin-right: 5px; display: inline-flex; align-items: center; justify-content: center; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 5px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,.2); opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; }
        .filter-controls input, .filter-controls select, .filter-controls button { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .progress-bar { width: 100%; background-color: var(--secondary-bg); border-radius: 5px; overflow: hidden; height: 22px; }
        .progress-bar-fill { height: 100%; background-color: var(--primary-accent); text-align: right; color: white; padding: 0 8px; line-height: 22px; font-size: .8rem; white-space: nowrap; transition: width .5s ease-out; }
        .category-badge { background-color: var(--secondary-bg); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
        .search-bar { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px; font-size: 1rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border-color); }
        
        table.hide-category .col-category { display: none; }
        table.hide-person .col-person { display: none; }
    </style>
</head>
<body>
    <div id="loader-container" class="loader-container"><div class="mini-loader"></div><span>Loading Dashboard...</span></div>
    
    <div id="modal-container"></div>

    <div id="app-container" class="container">
        <header class="app-header">
            <img src="https://upload.wikimedia.org/wikipedia/en/3/35/Indira_Gandhi_Institute_of_Medical_Sciences_Logo.png" alt="IGIMS Logo" onerror="this.style.display='none'">
            <h1>CEREBREXIA - FINANCE TRACKER</h1>
        </header>

        <nav>
            <button class="nav-btn active" data-page="dashboard"><i class="fas fa-chart-line"></i>Dashboard</button>
            <button class="nav-btn" data-page="summary"><i class="fas fa-chart-pie"></i>Summary</button>
            <button class="nav-btn" data-page="expected_funds"><i class="fas fa-wallet"></i>Expected Funds</button>
            <button class="nav-btn" data-page="budgets"><i class="fas fa-bullseye"></i>Budgets</button>
            <button class="nav-btn" data-page="passbook"><i class="fas fa-book"></i>Passbook</button>
            <button class="nav-btn" data-page="manage_data"><i class="fas fa-edit"></i>Manage Data</button>
            <button class="nav-btn" data-page="settings"><i class="fas fa-cog"></i>Settings</button>
        </nav>

        <main>
            <div id="page-dashboard" class="page active">
                <h2 class="section-title">Financial Overview</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <div class="card income"><h3>Total Income</h3><p class="amount" id="total-income">₹0</p></div>
                    <div class="card expense"><h3>Total Expenses</h3><p class="amount" id="total-expenses">₹0</p></div>
                    <div class="card"><h3>Net Balance</h3><p class="amount" id="net-remaining">₹0</p></div>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="card info"><h3>Cash Flow (This Month)</h3><p class="amount" id="monthly-cashflow">₹0</p><p class="comparison" id="monthly-cashflow-details">+₹0 / -₹0</p></div>
                    <div class="card warning"><h3>Avg. Daily Expense</h3><p class="amount" id="avg-daily-expense">₹0</p><p class="comparison">(Last 30 days)</p></div>
                    <div class="card danger"><h3>Projected Runway</h3><p class="amount" id="runway-days">-- Days</p><p class="comparison">At current burn rate</p></div>
                </div>
                
                <div class="section-box" style="margin-bottom: 30px;">
                    <h3 class="section-subtitle">Balances by Person</h3>
                    <div id="person-balances-container" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    </div>
                </div>
                
                <div class="section-box">
                    <div id="charts-starter">
                        <h3 class="section-subtitle">Financial Charts</h3>
                        <p>Visualize your financial data with interactive charts.</p>
                        <button id="show-charts-btn" class="action-btn" style="margin-top: 15px;">Show Financial Charts</button>
                    </div>
                    <div id="charts-interactive-area" style="display: none;">
                         <div class="filter-controls" style="padding-bottom: 20px;">
                             <label for="chart-type-select">Chart Type:</label>
                             <select id="chart-type-select">
                                 <option value="balance">Balance Over Time</option>
                                 <option value="income-cat">Income by Category</option>
                                 <option value="expense-cat">Expense by Category</option>
                                 <option value="expense-subcat">Expense by Subcategory</option>
                             </select>
                         </div>
                         <div style="height: 400px;">
                             <canvas id="dashboard-main-chart"></canvas>
                         </div>
                    </div>
                </div>

            </div>
            <div id="page-summary" class="page">
                <h2 class="section-title">Financial Summary</h2>
                <div class="filter-controls section-box" style="margin-bottom: 20px;">
                    <label>Period:</label>
                   <select id="summary-period-filter">
						<option value="month">This Month</option>
						<option value="year">This Year</option>	
						<option value="week">This Week</option>
						<option value="last-month">Last Month</option>
						<option value="custom">Custom Range</option>
					</select>
                    <div id="summary-custom-range" style="display:none; gap: 15px;">
                        <input type="date" id="summary-start-date">
                        <input type="date" id="summary-end-date">
                    </div>
                    <button id="summary-apply-filter" class="action-btn">Apply</button>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                    <div class="card income"><h3>Income</h3><p class="amount" id="summary-income">₹0</p><p class="comparison" id="summary-income-comp">vs previous period</p></div>
                    <div class="card expense"><h3>Expenses</h3><p class="amount" id="summary-expense">₹0</p><p class="comparison" id="summary-expense-comp">vs previous period</p></div>
                    <div class="card"><h3>Net</h3><p class="amount" id="summary-net">₹0</p><p class="comparison" id="summary-net-comp">vs previous period</p></div>
                </div>
                <div class="section-box">
                    <h3 class="section-subtitle">Category Breakdown</h3>
                    <div class="table-container"><table id="category-breakdown-table"></table></div>
                </div>
            </div>
            <div id="page-expected_funds" class="page">
                <h2 class="section-title">Expected Funds</h2>
                <div class="grid" style="grid-template-columns: 1fr;">
                     <div class="card expected" style="border-left-color: var(--info-color);"><h3>Total Remaining to Receive</h3><p class="amount" id="total-remaining-expected">₹0</p></div>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 2fr;">
                    <div class="section-box">
                        <h3 class="section-subtitle">Add Expectation</h3>
                        <form id="expected-form" class="form">
                            <input type="text" id="expected-source" placeholder="Source (e.g., Sponsor)" required>
                            <input type="number" id="expected-amount" placeholder="Expected Amount" required>
                            <button type="submit" style="background-color: var(--warning-color); color: var(--text-primary);">Add Expectation</button>
                        </form>
                    </div>
                    <div class="section-box">
                        <h3 class="section-subtitle">Forecast List</h3>
                        <div class="table-container" style="max-height: 300px;">
                            <table id="expected-funds-table">
                                <thead><tr><th>Source</th><th>Expected</th><th>Received</th><th>Remaining</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-budgets" class="page">
                <h2 class="section-title">Budget Management</h2>
                <div class="grid" style="grid-template-columns: 1fr 2fr; align-items: flex-start;">
                    <div class="section-box">
                        <h3 class="section-subtitle">Add/Update Budget</h3>
                        <form id="add-budget-form" class="form">
                            <select id="budget-category" required>
                                <option value="" disabled selected>Select an Expense Category</option>
                            </select>
                            <input type="number" id="budget-amount" placeholder="Budget Amount" required>
                            <button type="submit" style="background-color: var(--primary-accent);">Set Budget</button>
                        </form>
                        <h3 class="section-subtitle" style="margin-top: 20px;">Defined Budgets</h3>
                        <div class="table-container" style="max-height: 250px;">
                            <table id="defined-budgets-table">
                                <thead><tr><th>Category</th><th>Amount</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="section-box">
                        <h3 class="section-subtitle">Overall Spending vs Budget</h3>
                        <div id="budgets-container" class="grid" style="grid-template-columns: 1fr 1fr;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-passbook" class="page">
                <h2 class="section-title">Transaction Passbook</h2>
                <div class="section-box">
                    <div class="filter-controls">
                        <input type="date" id="start-date-filter">
                        <input type="date" id="end-date-filter">
                        <select id="category-filter"><option value="">All Parent Categories</option></select>
                        <select id="subcategory-filter"><option value="">All Subcategories</option></select>
                        <select id="type-filter"><option value="">All Types</option><option value="Income">Income</option><option value="Expense">Expense</option></select>
                        <select id="person-filter"><option value="">All People</option></select>
                        <button id="filter-btn" class="action-btn">Filter</button>
                        <button id="clear-filter-btn" class="action-btn" style="background-color: var(--text-secondary);">Clear</button>
                        <button id="toggle-category-col" class="action-btn" style="background-color: var(--text-secondary); margin-left: auto;">Hide Category</button>
                        <button id="toggle-person-col" class="action-btn" style="background-color: var(--text-secondary);">Hide Person</button>
                        <button id="export-csv-btn" class="action-btn" style="background-color: var(--success-color);">Export to CSV</button>
                    </div>
                    <div class="table-container">
                        <table id="passbook-table">
                            <thead><tr><th>Date</th><th>Description</th><th class="col-category">Category</th><th class="col-person">Person</th><th>Type</th><th>Amount</th><th>Balance</th><th>Receipt</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="page-manage_data" class="page">
                <h2 class="section-title">Add & Manage Manual Entries</h2>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; align-items: flex-start;">
                    <div class="section-box">
                        <h3><i class="fas fa-plus-circle" style="color:var(--success-color)"></i> Add Income</h3>
                        <form id="income-form" class="form">
                            <input type="date" id="income-date" required>
                            <input type="text" id="income-desc" placeholder="Description" required>
                            <select id="income-category" required><option value="" disabled selected>Category</option></select>
                            <select id="income-subcategory" style="display: none;"></select>
                            <select id="income-person" required><option value="" disabled selected>Person Receiving</option></select>
                            <input type="number" step="0.01" id="income-amount" placeholder="Amount" required>
                            <button type="submit" style="background-color: var(--success-color);">Add Income</button>
                        </form>
                    </div>
                    <div class="section-box">
                        <h3><i class="fas fa-minus-circle" style="color:var(--danger-color)"></i> Add Expense</h3>
                        <form id="expense-form" class="form">
                            <input type="date" id="expense-date" required>
                            <input type="text" id="expense-desc" placeholder="Description" required>
                            <select id="expense-category" required><option value="" disabled selected>Category</option></select>
                            <select id="expense-subcategory" style="display: none;"></select>
                            <select id="expense-person" required><option value="" disabled selected>Person Paying</option></select>
                            <input type="number" step="0.01" id="expense-amount" placeholder="Amount" required>
                            <input type="file" id="receipt-upload" accept="image/*,application/pdf">
                            <button type="submit" style="background-color: var(--danger-color);">Add Expense</button>
                        </form>
                    </div>

                    <div class="section-box">
                        <h3><i class="fas fa-exchange-alt" style="color:var(--info-color)"></i> Inter-Account Transfer</h3>
                        <form id="transfer-form" class="form">
                            <input type="date" id="transfer-date" required>
                            <input type="text" id="transfer-desc" placeholder="Description (e.g., Loan Repay)" required>
                            <select id="transfer-from-person" required><option value="" disabled selected>Transfer From</option></select>
                            <select id="transfer-to-person" required><option value="" disabled selected>Transfer To</option></select>
                            <input type="number" step="0.01" id="transfer-amount" placeholder="Amount" required>
                            <button type="submit" style="background-color: var(--info-color);">Transfer Funds</button>
                        </form>
                    </div>
                    </div>
                <div class="section-box" style="margin-top: 30px;">
                    <h3 class="section-subtitle">Manage Income Entries</h3>
                    <input type="text" id="search-income" class="search-bar" placeholder="Search income entries...">
                    <div class="table-container"><table id="manage-income-table"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Assigned To</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <div class="section-box" style="margin-top: 30px;">
                    <h3 class="section-subtitle">Manage Expense Entries</h3>
                    <input type="text" id="search-expense" class="search-bar" placeholder="Search expense entries...">
                    <div class="table-container"><table id="manage-expense-table"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            
            <div id="page-settings" class="page">
                <h2 class="section-title">Settings</h2>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; align-items: flex-start;">
                    <div class="section-box">
                        <h3 class="section-subtitle"><i class="fas fa-users"></i> Manage People</h3>
                        <form id="add-person-form" class="form" style="margin-bottom: 20px;">
                            <input type="text" id="person-name" placeholder="New Person's Name" required>
                            <button type="submit" style="background-color: var(--primary-accent);">Add Person</button>
                        </form>
                        <div id="people-list"></div>
                    </div>

                    <div class="section-box">
                        <h3 class="section-subtitle"><i class="fas fa-tags"></i> Manage Categories</h3>
                        <form id="add-category-form" class="form" style="margin-bottom: 20px;">
                            <input type="text" id="category-name" placeholder="New Category Name" required>
                            <select id="category-type" required>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                            </select>
                            <button type="submit" style="background-color: var(--success-color);">Add Category</button>
                        </form>
                        <div id="income-category-list">
                            <h4>Income Categories</h4>
                        </div>
                        <hr style="margin: 20px 0;">
                        <div id="expense-category-list">
                             <h4>Expense Categories</h4>
                        </div>
                    </div>

                    <div class="section-box">
                        <h3 class="section-subtitle"><i class="fas fa-sitemap"></i> Manage Subcategories</h3>
                        <form id="add-subcategory-form" class="form" style="margin-bottom: 20px;">
                            <select id="parent-category-select" required>
                                <option value="" disabled selected>Select Parent Category</option>
                            </select>
                            <input type="text" id="subcategory-name" placeholder="New Subcategory Name" required>
                            <button type="submit" style="background-color: var(--info-color);">Add Subcategory</button>
                        </form>
                         <div id="subcategory-list">
                         </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        // ===================================================================================
        // === 🚨 IMPORTANT SETUP INSTRUCTIONS 🚨 ==========================================
        // ===================================================================================
        
        // 1. FIREBASE CONFIGURATION (RESTORED AS PER YOUR REQUEST)
       const firebaseConfig = {
     apiKey: "AIzaSyD1ZKsLTqnAfD_SSU3iQ36pU3aG71DZKGk",
     authDomain: "expensetrackerpro-f5964.firebaseapp.com",
     projectId: "expensetrackerpro-f5964",
     storageBucket: "expensetrackerpro-f5964.firebasestorage.app",
     messagingSenderId: "409195239506",
     appId: "1:409195239506:web:717208fd6d28687604a78b",
     measurementId: "G-0HTGG3S8EM"
    };

        // 2. GOOGLE SHEET CONFIGURATION (RESTORED)
        const GOOGLE_API_KEY = 'AIzaSyBsf5q3I_HUMnuNC_Xel_cc6C29UYcO-Xs';
        const SHEET_ID = '1tru8u40xpTHIkr7zYSFK79TSOz4fHHiTkG_6r-zi6CQ';
        const SHEET_RANGE = "'22 BATCH'!E122";

        // ===================================================================================
        // === APPLICATION CODE ==============================================================
        // ===================================================================================

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const functions = getFunctions(app);

        // --- GLOBAL STATE & UI ELEMENTS ---
        const state = {
            transactions: [],
            batchTransactions: [], 
            expected: [],
            budgets: {},
            people: [],
            categories: [],
            isLoading: false,
        };
        let mainChartInstance = null;
        const loader = document.getElementById('loader-container');

        // --- HELPER FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(amount || 0);
        const todayISO = () => new Date().toISOString().split('T')[0];
        const formatDateForInput = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toISOString().split('T')[0];
        };
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container') || document.body.appendChild(Object.assign(document.createElement('div'), { id: 'toast-container' }));
            const toast = Object.assign(document.createElement('div'), {
                className: `toast`,
                style: `background-color: ${type === 'error' ? 'var(--danger-color)' : 'var(--success-color)'}`,
                textContent: message
            });
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };
        const setLoading = (isLoading, text = 'Working...') => {
            state.isLoading = isLoading;
            loader.querySelector('span').textContent = text;
            loader.classList.toggle('show', isLoading);
        };
        
        function showConfirmModal(message) {
            const modalContainer = document.getElementById('modal-container');
            const modalHTML = `
                <div class="overlay show">
                    <div class="modal-content">
                        <h3 class="section-subtitle">${message}</h3>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button id="confirm-cancel-btn" class="action-btn" style="background-color: var(--text-secondary);">Cancel</button>
                            <button id="confirm-ok-btn" class="action-btn" style="background-color: var(--danger-color);">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;

            return new Promise((resolve) => {
                document.getElementById('confirm-ok-btn').onclick = () => { closeModal(); resolve(true); };
                document.getElementById('confirm-cancel-btn').onclick = () => { closeModal(); resolve(false); };
            });
        }
        window.closeModal = () => { document.getElementById('modal-container').innerHTML = ''; };


        // --- DATA FETCHING & REAL-TIME LISTENERS ---
        async function fetchSheetData() {
            if (!GOOGLE_API_KEY || !SHEET_ID || !SHEET_RANGE) return;
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}?key=${GOOGLE_API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch sheet data. Check API key and Sheet ID.');
                const data = await response.json();
                if (!data.values || !data.values[0] || !data.values[0][0]) return;
                
                const totalAmount = parseFloat(data.values[0][0].replace(/[^0-9.-]+/g,""));
                if (isNaN(totalAmount)) return;

                const tagDoc = await getDoc(doc(db, "sheetTags", "batchIncome"));
                const person = tagDoc.exists() ? tagDoc.data().person : null;

                state.batchTransactions = [{
                    id: 'sheet-total-batch',
                    date: todayISO(),
                    description: 'MBBS 22 BATCH (From Sheet)',
                    amount: totalAmount,
                    type: 'Income',
                    category: 'Batch Collection',
                    person: person,
                    isSheet: true, 
                }];
            } catch (error) {
                console.error("Error fetching Google Sheet data:", error);
                showToast(error.message, "error");
            }
        }

        function setupRealtimeListeners() {
            setLoading(true, 'Fetching data...');

            const qTransactions = query(collection(db, "transactions"), orderBy("date", "desc"));
            onSnapshot(qTransactions, snapshot => {
                state.transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date ? formatDateForInput(doc.data().date) : todayISO(),
                }));
                renderAll();
                setLoading(false);
            }, error => {
                console.error("Error fetching transactions: ", error);
                showToast("Error: Could not fetch transactions.", "error");
                setLoading(false);
            });

            const qExpected = query(collection(db, "expectedPayments"), orderBy("createdAt", "desc"));
            onSnapshot(qExpected, snapshot => {
                state.expected = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error("Error fetching expected payments: ", error));

            onSnapshot(collection(db, "budgets"), snapshot => {
                state.budgets = snapshot.docs.reduce((acc, doc) => {
                    acc[doc.id] = doc.data().budgetAmount;
                    return acc;
                }, {});
                renderAll();
            }, error => console.error("Error fetching budgets: ", error));

            onSnapshot(collection(db, "people"), snapshot => {
                state.people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error("Error fetching people: ", error));

            const qCategories = query(collection(db, "categories"), orderBy("name"));
            onSnapshot(qCategories, snapshot => {
                state.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error("Error fetching categories: ", error));
            
            onSnapshot(doc(db, "sheetTags", "batchIncome"), (doc) => {
                if(state.batchTransactions.length > 0) {
                    const person = doc.exists() ? doc.data().person : null;
                    state.batchTransactions[0].person = person;
                    renderAll();
                }
            });
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            const activePageId = document.querySelector('.page.active')?.id;
            if (!activePageId) return;
            
            const allTransactions = [...state.transactions, ...state.batchTransactions];

            populateAllDropdowns();

            switch(activePageId) {
                case 'page-dashboard': renderDashboard(allTransactions); break;
                case 'page-summary': updateSummaryPage(allTransactions); break;
                case 'page-expected_funds': renderExpectedFunds(state.expected); break;
                case 'page-budgets': renderBudgets(allTransactions, state.budgets); break;
                case 'page-passbook': renderPassbook(allTransactions); break;
                case 'page-manage_data': renderManageDataTables(state.transactions, state.batchTransactions); break;
                case 'page-settings': renderSettingsPage(); break;
            }
        }

        function renderDashboard(data) {
            const income = data.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0);
            const expenses = data.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expenses').textContent = formatCurrency(expenses);
            document.getElementById('net-remaining').textContent = formatCurrency(income - expenses);
            
            const thisMonthTxns = data.filter(t => dayjs(t.date).isSame(dayjs(), 'month'));
            const monthlyIncome = thisMonthTxns.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0);
            const monthlyExpense = thisMonthTxns.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('monthly-cashflow').textContent = formatCurrency(monthlyIncome - monthlyExpense);
            document.getElementById('monthly-cashflow-details').textContent = `+${formatCurrency(monthlyIncome)} / ${formatCurrency(monthlyExpense)}`;

            const last30DaysExpenses = data
                .filter(t => t.type === 'Expense' && dayjs(t.date).isAfter(dayjs().subtract(30, 'day')))
                .reduce((s, t) => s + t.amount, 0);
            const avgDailyExpense = last30DaysExpenses > 0 ? last30DaysExpenses / 30 : 0;
            document.getElementById('avg-daily-expense').textContent = formatCurrency(avgDailyExpense);

            const runwayDays = avgDailyExpense > 0 ? Math.floor((income - expenses) / avgDailyExpense) : Infinity;
            document.getElementById('runway-days').textContent = isFinite(runwayDays) ? `${runwayDays} Days` : '∞ Days';

            renderPersonBalances(data);
            
            if (document.getElementById('charts-interactive-area').style.display === 'block') {
                updateDashboardChart();
            }
        }

        function renderPersonBalances(transactions) {
            const container = document.getElementById('person-balances-container');
            container.innerHTML = '';
            const balances = {};

            state.people.forEach(p => {
                balances[p.name] = { income: 0, expense: 0, net: 0 };
            });

            transactions.forEach(t => {
                if (t.person && balances[t.person] !== undefined) {
                    if (t.type === 'Income') {
                        balances[t.person].income += t.amount;
                    } else {
                        balances[t.person].expense += t.amount;
                    }
                }
            });

            for (const personName in balances) {
                const balance = balances[personName];
                balance.net = balance.income - balance.expense;
                
                const card = document.createElement('div');
                card.className = 'card info';
                card.innerHTML = `
                    <h3><i class="fas fa-user-circle"></i> ${personName}</h3>
                    <p class="amount">${formatCurrency(balance.net)}</p>
                    <p class="comparison" style="color: var(--success-color);">In: ${formatCurrency(balance.income)}</p>
                    <p class="comparison" style="color: var(--danger-color);">Out: ${formatCurrency(balance.expense)}</p>
                `;
                container.appendChild(card);
            }
             if (Object.keys(balances).length === 0) {
                 container.innerHTML = '<p>No people added yet. Go to Settings to add a person.</p>';
             }
        }
        
        function updateDashboardChart() {
            if (mainChartInstance) {
                mainChartInstance.destroy();
            }
            
            const allTransactions = [...state.transactions, ...state.batchTransactions];
            const chartType = document.getElementById('chart-type-select').value;
            const ctx = document.getElementById('dashboard-main-chart').getContext('2d');
            let chartConfig;

            const getChartColors = (count) => {
                const colors = ['#005A9C', '#4CAF50', '#FFC107', '#E91E63', '#9C27B0', '#2196F3', '#FF9800', '#795548', '#607D8B', '#00BCD4'];
                return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
            };

            switch (chartType) {
                case 'balance':
                    const sortedTxns = [...allTransactions].sort((a, b) => dayjs(a.date).diff(dayjs(b.date)));
                    let currentBalance = 0;
                    const dailyBalances = {};
                    sortedTxns.forEach(txn => {
                        currentBalance += (txn.type === 'Income' ? txn.amount : -txn.amount);
                        dailyBalances[txn.date] = currentBalance;
                    });
                    const labels = Object.keys(dailyBalances).sort((a,b) => dayjs(a).diff(dayjs(b)));
                    const dataPoints = labels.map(label => dailyBalances[label]);
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Net Balance', data: dataPoints, borderColor: 'var(--primary-accent)',
                                backgroundColor: 'rgba(0, 90, 156, 0.1)', fill: true, tension: 0.1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: (value) => formatCurrency(value) } } } }
                    };
                    break;

                case 'income-cat':
                case 'expense-cat':
                case 'expense-subcat':
                    const isIncome = chartType === 'income-cat';
                    const type = isIncome ? 'Income' : 'Expense';
                    const groupBySub = chartType === 'expense-subcat';

                    const groupedData = allTransactions
                        .filter(t => t.type === type && (groupBySub ? t.subcategory : true))
                        .reduce((acc, t) => {
                            const key = groupBySub ? t.subcategory : t.category;
                            if (key) {
                                acc[key] = (acc[key] || 0) + t.amount;
                            }
                            return acc;
                        }, {});

                    chartConfig = {
                        type: isIncome ? 'doughnut' : 'pie',
                        data: {
                            labels: Object.keys(groupedData),
                            datasets: [{
                                data: Object.values(groupedData),
                                backgroundColor: getChartColors(Object.keys(groupedData).length)
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                    };
                    break;
            }

            if (chartConfig) {
                mainChartInstance = new Chart(ctx, chartConfig);
            }
        }


        function updateSummaryPage(transactions) {
            const periodFilter = document.getElementById('summary-period-filter').value;
            let start, end, pStart, pEnd;
            const now = dayjs();
            
            if (periodFilter === 'year') {
                start = now.startOf('year'); end = now.endOf('year');
                pStart = start.subtract(1, 'year'); pEnd = end.subtract(1, 'year');
            } else if (periodFilter === 'week') {
                start = now.startOf('week'); end = now.endOf('week');
                pStart = start.subtract(1, 'week'); pEnd = end.subtract(1, 'week');
            } else if (periodFilter === 'last-month') {
                start = now.subtract(1, 'month').startOf('month'); end = now.subtract(1, 'month').endOf('month');
                pStart = start.subtract(1, 'month'); pEnd = end.subtract(1, 'month');
            } else if (periodFilter === 'custom') {
                start = dayjs(document.getElementById('summary-start-date').value); 
                end = dayjs(document.getElementById('summary-end-date').value);
                const diff = end.diff(start, 'day');
                pStart = start.subtract(diff + 1, 'day'); pEnd = end.subtract(diff + 1, 'day');
            } else { // Default to month
                start = now.startOf('month'); end = now.endOf('month');
                pStart = start.subtract(1, 'month'); pEnd = end.subtract(1, 'month');
            }

            const currentPeriodTxns = transactions.filter(t => dayjs(t.date).isBetween(start, end, null, '[]'));
            const prevPeriodTxns = transactions.filter(t => dayjs(t.date).isBetween(pStart, pEnd, null, '[]'));
            
            const calculateMetrics = (txns) => ({
                income: txns.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0),
                expense: txns.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0),
            });

            const currentMetrics = calculateMetrics(currentPeriodTxns); currentMetrics.net = currentMetrics.income - currentMetrics.expense;
            const prevMetrics = calculateMetrics(prevPeriodTxns); prevMetrics.net = prevMetrics.income - prevMetrics.expense;
            
            const formatComp = (current, previous) => {
                if (previous === 0) return current > 0 ? `(↑)` : ``;
                const percentChange = ((current - previous) / Math.abs(previous)) * 100;
                return `<span style="color:${percentChange >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">(${percentChange >= 0 ? '↑' : '↓'} ${Math.abs(percentChange).toFixed(1)}%)</span> vs prev. period`;
            };
            
            document.getElementById('summary-income').textContent = formatCurrency(currentMetrics.income);
            document.getElementById('summary-income-comp').innerHTML = formatComp(currentMetrics.income, prevMetrics.income);
            document.getElementById('summary-expense').textContent = formatCurrency(currentMetrics.expense);
            document.getElementById('summary-expense-comp').innerHTML = formatComp(currentMetrics.expense, prevMetrics.expense);
            document.getElementById('summary-net').textContent = formatCurrency(currentMetrics.net);
            document.getElementById('summary-net-comp').innerHTML = formatComp(currentMetrics.net, prevMetrics.net);
            
            renderCategoryBreakdown(currentPeriodTxns, prevPeriodTxns);
        }

        function renderCategoryBreakdown(currentTxns, prevTxns) {
            const table = document.getElementById('category-breakdown-table');
            const getCategoryTotals = (txns) => txns.reduce((acc, t) => {
                const catName = t.category; 
                if (!catName) return acc;
                if (!acc[catName]) acc[catName] = { income: 0, expense: 0 };
                acc[catName][t.type.toLowerCase()] += t.amount;
                return acc;
            }, {});

            const currentCategoryTotals = getCategoryTotals(currentTxns);
            const prevCategoryTotals = getCategoryTotals(prevTxns);
            const totalCurrentExpense = Object.values(currentCategoryTotals).reduce((sum, cat) => sum + cat.expense, 0);
            const allCategories = [...new Set([...Object.keys(currentCategoryTotals), ...Object.keys(prevCategoryTotals)])];

            let tableHTML = '<thead><tr><th>Category</th><th>Type</th><th>Amount</th><th>% of Total Expense</th><th>Change vs Prev.</th></tr></thead><tbody>';
            for(const category of allCategories.sort()) {
                const current = currentCategoryTotals[category] || { income: 0, expense: 0 };
                const previous = prevCategoryTotals[category] || { income: 0, expense: 0 };
                if (current.income > 0) {
                    const change = current.income - previous.income;
                    tableHTML += `<tr><td>${category}</td><td><span class="category-badge" style="background-color:#d4edda; color:#155724;">Income</span></td><td>${formatCurrency(current.income)}</td><td>-</td><td style="color:${change >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${change >= 0 ? '+' : ''}${formatCurrency(change)}</td></tr>`;
                }
                if (current.expense > 0) {
                    const change = current.expense - previous.expense;
                    const percentOfTotal = totalCurrentExpense > 0 ? (current.expense / totalCurrentExpense * 100).toFixed(1) + '%' : '0%';
                    tableHTML += `<tr><td>${category}</td><td><span class="category-badge" style="background-color:#f8d7da; color:#721c24;">Expense</span></td><td>${formatCurrency(current.expense)}</td><td>${percentOfTotal}</td><td style="color:${change <= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${change >= 0 ? '+' : ''}${formatCurrency(change)}</td></tr>`;
                }
            }
            table.innerHTML = tableHTML + '</tbody>';
        }

        function renderExpectedFunds(data) {
            const totalExpected = data.reduce((s, t) => s + t.expectedAmount, 0);
            const totalReceived = data.reduce((s, t) => s + t.receivedAmount, 0);
            document.getElementById('total-remaining-expected').textContent = formatCurrency(totalExpected - totalReceived);
            
            const sortedData = [...data].sort((a, b) => {
                const timeA = a.updatedAt ? a.updatedAt.toMillis() : (a.createdAt ? a.createdAt.toMillis() : 0);
                const timeB = b.updatedAt ? b.updatedAt.toMillis() : (b.createdAt ? b.createdAt.toMillis() : 0);
                return timeB - timeA;
            });

            const tbody = document.querySelector("#expected-funds-table tbody");
            tbody.innerHTML = sortedData.map(item => {
                const remaining = item.expectedAmount - item.receivedAmount;
                return `<tr>
                    <td>${item.source}</td>
                    <td>${formatCurrency(item.expectedAmount)}</td>
                    <td>${formatCurrency(item.receivedAmount)}</td>
                    <td>${formatCurrency(remaining)}</td>
                    <td>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${remaining > 0 ? `<button class="action-btn" data-id="${item.id}" data-action="receive" title="Receive Funds" style="background-color: var(--success-color);"><i class="fas fa-hand-holding-usd"></i></button>` : '<span style="color: var(--text-secondary);">Completed</span>'}
                            <button class="action-btn" data-id="${item.id}" data-action="edit-expected" title="Edit Expected Fund"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" data-id="${item.id}" data-action="delete-expected" title="Delete Expected Fund" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('') || `<tr><td colspan="5">No expected funds added.</td></tr>`;

            tbody.querySelectorAll('button[data-action="receive"]').forEach(button => {
                button.onclick = (e) => openReceiveExpectedModal(e.currentTarget.dataset.id);
            });
            tbody.querySelectorAll('button[data-action="edit-expected"]').forEach(button => {
                button.onclick = (e) => openEditExpectedModal(e.currentTarget.dataset.id);
            });
            tbody.querySelectorAll('button[data-action="delete-expected"]').forEach(button => {
                button.onclick = (e) => deleteExpectedEntry(e.currentTarget.dataset.id);
            });
        }

        function renderBudgets(transactions, budgets) {
            const budgetsContainer = document.getElementById('budgets-container');
            const definedBudgetsTbody = document.querySelector("#defined-budgets-table tbody");
            budgetsContainer.innerHTML = '';
            definedBudgetsTbody.innerHTML = '';

            if (Object.keys(budgets).length > 0) {
                for (const category in budgets) {
                    definedBudgetsTbody.innerHTML += `
                        <tr>
                            <td>${category}</td>
                            <td>${formatCurrency(budgets[category])}</td>
                            <td><button class="action-btn" data-category="${category}" data-action="delete-budget" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                }
            } else {
                definedBudgetsTbody.innerHTML = '<tr><td colspan="3">No budgets set.</td></tr>';
            }
            
            document.querySelectorAll('button[data-action="delete-budget"]').forEach(button => {
                button.onclick = (e) => deleteBudget(e.currentTarget.dataset.category);
            });

            const allExpenses = transactions.filter(t => t.type === 'Expense');
            
            const spendingByCategory = allExpenses.reduce((acc, t) => {
                if (t.category) {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                }
                return acc;
            }, {});


            if (Object.keys(budgets).length > 0) {
                for (const budgetCategory in budgets) {
                    const budgetAmount = parseFloat(budgets[budgetCategory]);
                    const spentAmount = spendingByCategory[budgetCategory] || 0;
                    const percentage = budgetAmount > 0 ? (spentAmount / budgetAmount) * 100 : 0;
                    let progressBarColor = 'var(--success-color)';
                    if (percentage > 75 && percentage <= 100) progressBarColor = 'var(--warning-color)';
                    else if (percentage > 100) progressBarColor = 'var(--danger-color)';
                    
                    const budgetCard = document.createElement('div');
                    budgetCard.className = 'card info';
                    budgetCard.innerHTML = `<h3>${budgetCategory}</h3><p>Spent ${formatCurrency(spentAmount)} of ${formatCurrency(budgetAmount)}</p><div class="progress-bar" style="margin-top: 10px;"><div class="progress-bar-fill" style="width: ${Math.min(100, percentage)}%; background-color: ${progressBarColor};">${percentage.toFixed(0)}%</div></div>`;
                    budgetsContainer.appendChild(budgetCard);
                }
            } else {
                budgetsContainer.innerHTML = '<p>No budgets defined. Use the form on the left to add one.</p>';
            }
        }
        
        function renderPassbook(data) {
            const tableBody = document.querySelector("#passbook-table tbody");
            tableBody.innerHTML = '';
            let currentBalance = 0;
            const sortedData = [...data].sort((a, b) => dayjs(a.date).diff(dayjs(b.date)));
            const reversedData = sortedData.slice().reverse();

            const balanceMap = new Map();
            sortedData.forEach(item => {
                currentBalance += (item.type === 'Income' ? item.amount : -item.amount);
                balanceMap.set(item.id, currentBalance);
            });

            tableBody.innerHTML = reversedData.map(item => {
                const receiptCell = item.isSheet ? 'From Google Sheet' : (item.receiptUrl ? `<a href="${item.receiptUrl}" target="_blank" class="action-btn" style="background-color:var(--info-color);"><i class="fas fa-receipt"></i> View</a>` : 'N/A');
                const categoryDisplay = item.subcategory ? `${item.category} &rarr; ${item.subcategory}` : item.category;
                
                return `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.description}</td>
                    <td class="col-category"><span class="category-badge">${categoryDisplay}</span></td>
                    <td class="col-person">${item.person || 'N/A'}</td>
                    <td style="color: ${item.type === 'Income' ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 500;">${item.type}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${formatCurrency(balanceMap.get(item.id))}</td>
                    <td>${receiptCell}</td>
                </tr>`
            }).join('') || `<tr><td colspan="8">No transactions found.</td></tr>`;
        }
        
        function renderManageDataTables(transactions, batchTransactions) {
            const incomeTableBody = document.querySelector("#manage-income-table tbody");
            const expenseTableBody = document.querySelector("#manage-expense-table tbody");
            
            const allIncomes = [...batchTransactions, ...transactions.filter(t => t.type === 'Income')];
            const expenses = transactions.filter(t => t.type === 'Expense');

            incomeTableBody.innerHTML = allIncomes.map(item => {
                const assignedTo = item.person ? item.person : '<span style="color: var(--danger-color);">Unassigned</span>';
                const actions = item.isSheet 
                    ? `<button class="action-btn" data-id="${item.id}" data-action="assign-person" style="background-color:var(--info-color);" title="Assign Person"><i class="fas fa-user-tag"></i></button>`
                    : `<button class="action-btn" data-id="${item.id}" data-type="Income" data-action="edit" title="Edit Entry"><i class="fas fa-edit"></i></button>
                       <button class="action-btn" data-id="${item.id}" data-type="Income" data-action="delete" style="background-color:var(--danger-color);" title="Delete Entry"><i class="fas fa-trash-alt"></i></button>`;
                return `<tr>
                            <td>${item.date}</td>
                            <td>${item.description}</td>
                            <td>${formatCurrency(item.amount)}</td>
                            <td>${assignedTo}</td>
                            <td>${actions}</td>
                        </tr>`;
            }).join('');

            expenseTableBody.innerHTML = expenses.map(item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.description}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        ${item.receiptUrl ? `<a href="${item.receiptUrl}" target="_blank" class="action-btn" style="background-color:var(--info-color);" title="View Receipt"><i class="fas fa-receipt"></i></a>` : ''}
                        <button class="action-btn" data-id="${item.id}" data-type="Expense" data-action="edit" title="Edit Entry"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" data-id="${item.id}" data-type="Expense" data-action="delete" style="background-color:var(--danger-color);" title="Delete Entry"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`
            ).join('');

            document.querySelectorAll('#manage-income-table button, #manage-expense-table button').forEach(button => {
                button.onclick = (e) => {
                    const { id, type, action } = e.currentTarget.dataset;
                    if (action === 'edit') openEditModal(id, type);
                    else if (action === 'delete') deleteEntry(id, type);
                    else if (action === 'assign-person') openAssignPersonModal();
                };
            });
        }

        function renderSettingsPage() {
            const peopleList = document.getElementById('people-list');
            peopleList.innerHTML = state.people.map(p => `
                <div class="list-item">
                    <span>${p.name}</span>
                    <button class="action-btn" data-id="${p.id}" data-action="delete-person" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i></button>
                </div>
            `).join('') || '<p>No people added yet.</p>';
            
            document.querySelectorAll('button[data-action="delete-person"]').forEach(btn => btn.onclick = (e) => deletePerson(e.currentTarget.dataset.id));

            const incomeCatList = document.getElementById('income-category-list');
            const expenseCatList = document.getElementById('expense-category-list');
            incomeCatList.innerHTML = '<h4>Income Categories</h4>';
            expenseCatList.innerHTML = '<h4>Expense Categories</h4>';

            const parentCategories = state.categories.filter(c => !c.parent);
            parentCategories.forEach(cat => {
                const list = cat.type === 'Income' ? incomeCatList : expenseCatList;
                const subcategories = state.categories.filter(s => s.parent === cat.name);
                let html = `
                    <div class="list-item">
                        <strong>${cat.name}</strong>
                        <button class="action-btn" data-id="${cat.id}" data-action="delete-category" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                if(subcategories.length > 0) {
                    html += `<div style="padding-left: 20px;">`;
                    subcategories.forEach(sub => {
                        html += `
                        <div class="list-item">
                            <span>&rarr; ${sub.name}</span>
                            <button class="action-btn" data-id="${sub.id}" data-action="delete-category" style="background-color:var(--danger-color); font-size: 0.8em;"><i class="fas fa-trash-alt"></i></button>
                        </div>`;
                    });
                    html += `</div>`;
                }
                list.innerHTML += html;
            });
            
            document.querySelectorAll('button[data-action="delete-category"]').forEach(btn => btn.onclick = (e) => deleteCategory(e.currentTarget.dataset.id));
        }


        function populateSelectWithOptions(selectElement, options, config = {}) {
            const { placeholder, valueField = 'name', textField = 'name', selectedValue } = config;
            const currentVal = selectElement.value;
            selectElement.innerHTML = placeholder ? `<option value="" disabled>${placeholder}</option>` : '';
            options.forEach(opt => {
                selectElement.innerHTML += `<option value="${opt[valueField]}">${opt[textField]}</option>`;
            });
            selectElement.value = selectedValue || currentVal || (placeholder ? "" : selectElement.options[0]?.value);
        }

        function populateAllDropdowns() {
            const peopleOptions = { placeholder: 'Select Person', selectedValue: '' };
            populateSelectWithOptions(document.getElementById('income-person'), state.people, { ...peopleOptions, placeholder: 'Person Receiving' });
            populateSelectWithOptions(document.getElementById('expense-person'), state.people, { ...peopleOptions, placeholder: 'Person Paying' });
            populateSelectWithOptions(document.getElementById('person-filter'), state.people, { placeholder: 'All People' });
            populateSelectWithOptions(document.getElementById('transfer-from-person'), state.people, { placeholder: 'Transfer From' });
            populateSelectWithOptions(document.getElementById('transfer-to-person'), state.people, { placeholder: 'Transfer To' });

            const incomeCategories = state.categories.filter(c => c.type === 'Income' && !c.parent);
            const expenseCategories = state.categories.filter(c => c.type === 'Expense' && !c.parent);
            
            populateSelectWithOptions(document.getElementById('income-category'), incomeCategories, { placeholder: 'Select Category' });
            populateSelectWithOptions(document.getElementById('expense-category'), expenseCategories, { placeholder: 'Select Category' });
            populateSelectWithOptions(document.getElementById('budget-category'), expenseCategories, { placeholder: 'Select Expense Category' });
            populateSelectWithOptions(document.getElementById('parent-category-select'), state.categories.filter(c=>!c.parent), { placeholder: 'Select Parent Category' });

            // START: Modified Passbook Filter Population
            // Populate the main category filter with ONLY parent categories
            const parentCategoriesForFilter = state.categories.filter(c => !c.parent);
            populateSelectWithOptions(document.getElementById('category-filter'), parentCategoriesForFilter, { placeholder: 'All Parent Categories' });

            // Populate the subcategory filter with ONLY subcategories
            const subCategoriesForFilter = state.categories.filter(c => c.parent);
            populateSelectWithOptions(document.getElementById('subcategory-filter'), subCategoriesForFilter, { placeholder: 'All Subcategories' });
            // END: Modified Passbook Filter Population
        }

        function handleCategoryChange(categorySelectId, subcategorySelectId) {
            const categorySelect = document.getElementById(categorySelectId);
            const subcategorySelect = document.getElementById(subcategorySelectId);
            const selectedCategoryName = categorySelect.value;
            const subcategories = state.categories.filter(c => c.parent === selectedCategoryName);

            if (subcategories.length > 0) {
                populateSelectWithOptions(subcategorySelect, subcategories, { placeholder: 'Select Subcategory' });
                subcategorySelect.style.display = 'block';
            } else {
                subcategorySelect.style.display = 'none';
                subcategorySelect.innerHTML = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            setLoading(true, 'Initializing...');
            await fetchSheetData();
            setupRealtimeListeners();
            
            document.getElementById('income-date').value = todayISO();
            document.getElementById('expense-date').value = todayISO();
            document.getElementById('transfer-date').value = todayISO();

            document.getElementById('income-category').addEventListener('change', () => handleCategoryChange('income-category', 'income-subcategory'));
            document.getElementById('expense-category').addEventListener('change', () => handleCategoryChange('expense-category', 'expense-subcategory'));
            
            document.getElementById('show-charts-btn').addEventListener('click', () => {
                document.getElementById('charts-starter').style.display = 'none';
                document.getElementById('charts-interactive-area').style.display = 'block';
                updateDashboardChart();
            });
            document.getElementById('chart-type-select').addEventListener('change', updateDashboardChart);

            const passbookTable = document.getElementById('passbook-table');
            const toggleCategoryBtn = document.getElementById('toggle-category-col');
            const togglePersonBtn = document.getElementById('toggle-person-col');

            toggleCategoryBtn.addEventListener('click', () => {
                passbookTable.classList.toggle('hide-category');
                toggleCategoryBtn.textContent = passbookTable.classList.contains('hide-category') ? 'Show Category' : 'Hide Category';
            });

            togglePersonBtn.addEventListener('click', () => {
                passbookTable.classList.toggle('hide-person');
                togglePersonBtn.textContent = passbookTable.classList.contains('hide-person') ? 'Show Person' : 'Hide Person';
            });
        });
        
        async function submitTransaction(formType, payload) {
            setLoading(true, `Adding ${payload.type}...`);
            try {
                let receiptUrl = '';
                if (payload.receiptFile) {
                    const storageRef = ref(storage, `receipts/${Date.now()}_${payload.receiptFile.name}`);
                    const snapshot = await uploadBytes(storageRef, payload.receiptFile);
                    receiptUrl = await getDownloadURL(snapshot.ref);
                }

                await addDoc(collection(db, "transactions"), {
                    date: Timestamp.fromDate(new Date(payload.date)),
                    type: payload.type,
                    description: payload.description,
                    category: payload.category,
                    subcategory: payload.subcategory || null,
                    person: payload.person,
                    amount: payload.amount,
                    receiptUrl: receiptUrl,
                    createdAt: serverTimestamp()
                });

                showToast(`${payload.type} added successfully!`, 'success');
                document.getElementById(`${formType}-form`).reset();
                document.getElementById(`${formType}-date`).value = todayISO();
                document.getElementById(`${formType}-subcategory`).style.display = 'none';
            } catch (error) {
                console.error(`Error adding ${payload.type}:`, error);
                showToast(`Error adding entry: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        document.getElementById('income-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitTransaction('income', {
                type: 'Income',
                date: document.getElementById('income-date').value,
                description: document.getElementById('income-desc').value,
                category: document.getElementById('income-category').value,
                subcategory: document.getElementById('income-subcategory').value,
                person: document.getElementById('income-person').value,
                amount: parseFloat(document.getElementById('income-amount').value)
            });
        });

        document.getElementById('expense-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitTransaction('expense', {
                type: 'Expense',
                date: document.getElementById('expense-date').value,
                description: document.getElementById('expense-desc').value,
                category: document.getElementById('expense-category').value,
                subcategory: document.getElementById('expense-subcategory').value,
                person: document.getElementById('expense-person').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                receiptFile: document.getElementById('receipt-upload').files[0]
            });
        });

        // START: New Listener for Inter-Account Transfer
        document.getElementById('transfer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fromPerson = document.getElementById('transfer-from-person').value;
            const toPerson = document.getElementById('transfer-to-person').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const date = document.getElementById('transfer-date').value;
            const description = document.getElementById('transfer-desc').value;

            if (fromPerson === toPerson) {
                showToast('Cannot transfer funds to the same person.', 'error');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showToast('Please enter a valid positive amount to transfer.', 'error');
                return;
            }

            setLoading(true, 'Processing Transfer...');

            const expenseTransaction = {
                date: Timestamp.fromDate(new Date(date)),
                type: 'Expense',
                description: `Transfer to ${toPerson}: ${description}`,
                category: 'Internal Transfer',
                subcategory: null,
                person: fromPerson,
                amount: amount,
                receiptUrl: '',
                createdAt: serverTimestamp()
            };

            const incomeTransaction = {
                date: Timestamp.fromDate(new Date(date)),
                type: 'Income',
                description: `Transfer from ${fromPerson}: ${description}`,
                category: 'Internal Transfer',
                subcategory: null,
                person: toPerson,
                amount: amount,
                receiptUrl: '',
                createdAt: serverTimestamp()
            };

            try {
                // Add both transactions
                await Promise.all([
                    addDoc(collection(db, "transactions"), expenseTransaction),
                    addDoc(collection(db, "transactions"), incomeTransaction)
                ]);

                showToast('Transfer completed successfully!', 'success');
                document.getElementById('transfer-form').reset();
                document.getElementById('transfer-date').value = todayISO();
            } catch (error) {
                console.error("Error processing transfer:", error);
                showToast(`Error processing transfer: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });
        // END: New Listener for Inter-Account Transfer

        document.getElementById('expected-form').addEventListener('submit', async (e) => {
            e.preventDefault(); setLoading(true);
            const source = document.getElementById('expected-source').value;
            const amount = parseFloat(document.getElementById('expected-amount').value);
            try {
                await addDoc(collection(db, "expectedPayments"), {
                    source: source,
                    expectedAmount: amount,
                    receivedAmount: 0,
                    createdAt: serverTimestamp()
                });
                showToast('Expected fund added!', 'success');
                e.target.reset();
            } catch (error) {
                showToast(`Error adding expected fund: ${error.message}`, 'error');
            } finally { setLoading(false); }
        });
        
        document.getElementById('add-budget-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            
            if (!category || isNaN(amount) || amount <= 0) {
                showToast('Please select a category and enter a valid positive amount.', 'error');
                return;
            }
            
            setLoading(true);
            try {
                await setDoc(doc(db, "budgets", category), { budgetAmount: amount });
                showToast(`Budget for ${category} has been set/updated!`, 'success');
                e.target.reset();
            } catch (error) {
                showToast(`Error setting budget: ${error.message}`, 'error');
            } finally { setLoading(false); }
        });

        document.getElementById('add-person-form').addEventListener('submit', async (e) => {
            e.preventDefault(); setLoading(true);
            const name = document.getElementById('person-name').value;
            try {
                await addDoc(collection(db, 'people'), { name });
                showToast('Person added!', 'success');
                e.target.reset();
            } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
            finally { setLoading(false); }
        });

        document.getElementById('add-category-form').addEventListener('submit', async (e) => {
            e.preventDefault(); setLoading(true);
            const name = document.getElementById('category-name').value;
            const type = document.getElementById('category-type').value;
            try {
                await addDoc(collection(db, 'categories'), { name, type, parent: null });
                showToast('Category added!', 'success');
                e.target.reset();
            } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
            finally { setLoading(false); }
        });

        document.getElementById('add-subcategory-form').addEventListener('submit', async (e) => {
            e.preventDefault(); setLoading(true);
            const parentCatName = document.getElementById('parent-category-select').value;
            const name = document.getElementById('subcategory-name').value;
            const parentCat = state.categories.find(c => c.name === parentCatName);
            if (!parentCat) {
                showToast('Parent category not found!', 'error');
                setLoading(false);
                return;
            }
            try {
                await addDoc(collection(db, 'categories'), { name, type: parentCat.type, parent: parentCatName });
                showToast('Subcategory added!', 'success');
                e.target.reset();
            } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
            finally { setLoading(false); }
        });

        function openModal(title, contentHTML) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="overlay show"><div class="modal-content"><h2 class="section-title">${title}</h2>${contentHTML}</div></div>`;
        }
        
        function createFormActionsHTML() {
            return `
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="action-btn" style="background-color: var(--text-secondary);" onclick="window.closeModal()">Cancel</button>
                    <button type="submit" class="action-btn">Save Changes</button>
                </div>
            `;
        }

        function openEditModal(id, type) {
            const item = state.transactions.find(t => t.id === id);
            if (!item) return;

            const categories = state.categories.filter(c => c.type === type && !c.parent);
            const subcategories = item.category ? state.categories.filter(c => c.parent === item.category) : [];

            const contentHTML = `
                <form id="edit-form" class="form">
                    <input type="date" id="edit-date" value="${item.date}" required>
                    <input type="text" id="edit-desc" placeholder="Description" value="${item.description}" required>
                    <select id="edit-person" required>${state.people.map(p => `<option value="${p.name}" ${item.person === p.name ? 'selected' : ''}>${p.name}</option>`).join('')}</select>
                    <select id="edit-category" required>${categories.map(cat => `<option value="${cat.name}" ${item.category === cat.name ? 'selected' : ''}>${cat.name}</option>`).join('')}</select>
                    <select id="edit-subcategory">${subcategories.map(sub => `<option value="${sub.name}" ${item.subcategory === sub.name ? 'selected' : ''}>${sub.name}</option>`).join('')}</select>
                    <input type="number" step="0.01" id="edit-amount" placeholder="Amount" value="${item.amount}" required>
                    ${item.receiptUrl ? `<p>Current: <a href="${item.receiptUrl}" target="_blank">View Receipt</a></p>` : ''}
                    <label>Upload New Receipt (optional):</label><input type="file" id="edit-receipt" accept="image/*,application/pdf">
                    ${createFormActionsHTML()}
                </form>`;
            openModal(`Edit ${type} Entry`, contentHTML);

            document.getElementById('edit-form').addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    const newReceiptFile = document.getElementById('edit-receipt').files[0];
                    let receiptUrlToUpdate = item.receiptUrl;

                    if (newReceiptFile) {
                        const storageRef = ref(storage, `receipts/${Date.now()}_${newReceiptFile.name}`);
                        const snapshot = await uploadBytes(storageRef, newReceiptFile);
                        receiptUrlToUpdate = await getDownloadURL(snapshot.ref);
                    }

                    await updateDoc(doc(db, "transactions", id), {
                        date: Timestamp.fromDate(new Date(document.getElementById('edit-date').value)),
                        description: document.getElementById('edit-desc').value,
                        category: document.getElementById('edit-category').value,
                        subcategory: document.getElementById('edit-subcategory').value || null,
                        person: document.getElementById('edit-person').value,
                        amount: parseFloat(document.getElementById('edit-amount').value),
                        receiptUrl: receiptUrlToUpdate,
                        updatedAt: serverTimestamp()
                    });
                    showToast('Entry updated!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Update failed: ${error.message}`, 'error');
                } finally { setLoading(false); }
            });
        }
        
        function openAssignPersonModal() {
            const currentPerson = state.batchTransactions[0]?.person;
            const contentHTML = `
                <form id="assign-person-form" class="form">
                    <p>Assign the total batch collection from the Google Sheet to a person's account.</p>
                    <select id="assign-person-select" required>
                        <option value="" disabled>Select Person</option>
                        ${state.people.map(p => `<option value="${p.name}" ${currentPerson === p.name ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                    ${createFormActionsHTML()}
                </form>`;
            openModal('Assign Batch Income', contentHTML);

            document.getElementById('assign-person-form').addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                const person = document.getElementById('assign-person-select').value;
                try {
                    await setDoc(doc(db, "sheetTags", "batchIncome"), { person });
                    showToast('Batch income assigned!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Assignment failed: ${error.message}`, 'error');
                } finally { setLoading(false); }
            });
        }

        function openReceiveExpectedModal(id) {
            const item = state.expected.find(e => e.id === id);
            if (!item) return;

            const contentHTML = `
                <form id="receive-expected-form" class="form">
                    <p><strong>Source:</strong> ${item.source}</p>
                    <p><strong>Remaining:</strong> ${formatCurrency(item.expectedAmount - item.receivedAmount)}</p>
                    <input type="number" step="0.01" id="receive-amount" placeholder="Amount to Receive" required max="${item.expectedAmount - item.receivedAmount}" value="${item.expectedAmount - item.receivedAmount}">
                    <input type="date" id="receive-date" value="${todayISO()}" required>
                    <select id="receive-person" required>${state.people.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}</select>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                         <button type="button" class="action-btn" style="background-color: var(--text-secondary);" onclick="window.closeModal()">Cancel</button>
                         <button type="submit" class="action-btn" style="background-color: var(--success-color);">Mark as Received</button>
                    </div>
                </form>`;
            openModal('Receive Expected Funds', contentHTML);

            document.getElementById('receive-expected-form').addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    const receiveAmount = parseFloat(document.getElementById('receive-amount').value);
                    const newTotalReceived = item.receivedAmount + receiveAmount;
                    
                    await updateDoc(doc(db, "expectedPayments", id), { 
                        receivedAmount: newTotalReceived,
                        updatedAt: serverTimestamp() // Add timestamp on receive
                    });
                    await addDoc(collection(db, "transactions"), {
                        date: Timestamp.fromDate(new Date(document.getElementById('receive-date').value)),
                        type: 'Income',
                        description: `Funds received from ${item.source}`,
                        category: 'Sponsorship',
                        person: document.getElementById('receive-person').value,
                        amount: receiveAmount,
                        receiptUrl: '',
                        createdAt: serverTimestamp()
                    });
                    showToast('Funds received!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Error receiving funds: ${error.message}`, 'error');
                } finally { setLoading(false); }
            });
        }

        function openEditExpectedModal(id) {
            const item = state.expected.find(e => e.id === id);
            if (!item) return;
            const contentHTML = `
                <form id="edit-expected-form" class="form">
                    <label for="edit-expected-source">Source:</label>
                    <input type="text" id="edit-expected-source" value="${item.source}" required>
                    <label for="edit-expected-amount">Expected Amount:</label>
                    <input type="number" step="0.01" id="edit-expected-amount" value="${item.expectedAmount}" required>
                    <label for="edit-expected-received">Received Amount:</label>
                    <input type="number" step="0.01" id="edit-expected-received" value="${item.receivedAmount}" required>
                    ${createFormActionsHTML()}
                </form>`;
            openModal('Edit Expected Fund Entry', contentHTML);

            document.getElementById('edit-expected-form').addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    await updateDoc(doc(db, "expectedPayments", id), {
                        source: document.getElementById('edit-expected-source').value,
                        expectedAmount: parseFloat(document.getElementById('edit-expected-amount').value),
                        receivedAmount: parseFloat(document.getElementById('edit-expected-received').value),
                        updatedAt: serverTimestamp()
                    });
                    showToast('Expected fund entry updated!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Update failed: ${error.message}`, 'error');
                } finally { setLoading(false); }
            });
        }

        async function deletePerson(id) {
            const confirmed = await showConfirmModal('Delete this person? This cannot be undone.');
            if (confirmed) {
                setLoading(true);
                try {
                    await deleteDoc(doc(db, "people", id));
                    showToast('Person deleted.', 'success');
                } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
                finally { setLoading(false); }
            }
        }

        async function deleteCategory(id) {
            const confirmed = await showConfirmModal('Delete this category? This cannot be undone.');
            if (confirmed) {
                setLoading(true);
                try {
                    await deleteDoc(doc(db, "categories", id));
                    showToast('Category deleted.', 'success');
                } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
                finally { setLoading(false); }
            }
        }

        async function deleteExpectedEntry(id) {
            const confirmed = await showConfirmModal('Are you sure you want to delete this expected fund entry?');
            if (confirmed) {
                setLoading(true);
                try {
                    await deleteDoc(doc(db, "expectedPayments", id));
                    showToast('Expected fund entry deleted!', 'success');
                } catch (error) {
                    showToast(`Error deleting: ${error.message}`, 'error');
                } finally { setLoading(false); }
            }
        }


        async function deleteEntry(id, type) {
            const confirmed = await showConfirmModal(`Are you sure you want to delete this ${type} entry?`);
            if (confirmed) {
                setLoading(true);
                try {
                    const docRef = doc(db, "transactions", id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().receiptUrl) {
                        const receiptRef = ref(storage, docSnap.data().receiptUrl);
                        await deleteObject(receiptRef).catch(err => {
                             if (err.code !== 'storage/object-not-found') throw err;
                        });
                    }
                    await deleteDoc(docRef);
                    showToast('Entry deleted successfully!', 'success');
                } catch (error) {
                    showToast(`Error deleting entry: ${error.message}`, 'error');
                } finally { setLoading(false); }
            }
        }
        
        async function deleteBudget(category) {
            const confirmed = await showConfirmModal(`Are you sure you want to delete the budget for "${category}"?`);
            if (confirmed) {
                setLoading(true);
                try {
                    await deleteDoc(doc(db, "budgets", category));
                    showToast(`Budget for "${category}" deleted.`, 'success');
                } catch (error) {
                    showToast(`Error deleting budget: ${error.message}`, 'error');
                } finally { setLoading(false); }
            }
        }

        document.querySelectorAll(".nav-btn").forEach(button => {
            button.addEventListener("click", function() {
                if (this.id === "sync-button") return;
                document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
                document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
                document.getElementById(`page-${this.dataset.page}`).classList.add("active");
                renderAll();
            })
        });
        document.getElementById("summary-period-filter").addEventListener("change",function(){document.getElementById("summary-custom-range").style.display=this.value==="custom"?"flex":"none"});
        document.getElementById("summary-apply-filter").addEventListener("click",() => updateSummaryPage([...state.transactions, ...state.batchTransactions]));
        
        document.getElementById("filter-btn").addEventListener("click",function(){
            const startDate=document.getElementById("start-date-filter").value;
            const endDate=document.getElementById("end-date-filter").value;
            const category=document.getElementById("category-filter").value;
            const subcategory=document.getElementById("subcategory-filter").value;
            const type=document.getElementById("type-filter").value;
            const person=document.getElementById("person-filter").value;
            let filtered=[...state.transactions, ...state.batchTransactions];
            if(startDate)filtered=filtered.filter(t=>dayjs(t.date).isSameOrAfter(dayjs(startDate)));
            if(endDate)filtered=filtered.filter(t=>dayjs(t.date).isSameOrBefore(dayjs(endDate)));
            if(category)filtered=filtered.filter(t=>t.category===category);
            if(subcategory)filtered=filtered.filter(t=>t.subcategory===subcategory);
            if(type)filtered=filtered.filter(t=>t.type===type);
            if(person)filtered=filtered.filter(t=>t.person===person);
            renderPassbook(filtered)
        });

        document.getElementById("clear-filter-btn").addEventListener("click",()=>{
            document.getElementById("start-date-filter").value="";
            document.getElementById("end-date-filter").value="";
            document.getElementById("category-filter").value="";
            document.getElementById("subcategory-filter").value="";
            document.getElementById("type-filter").value="";
            document.getElementById("person-filter").value="";
            renderPassbook([...state.transactions, ...state.batchTransactions])
        });

        document.getElementById("export-csv-btn").addEventListener("click",()=>{const table=document.getElementById("passbook-table");let csv=[[...table.querySelectorAll("thead th")].map(th=>`"${th.innerText}"`).join(",")];table.querySelectorAll("tbody tr").forEach(tr=>{let row=[...tr.querySelectorAll("td")].map(td=>`"${td.innerText.replace(/"/g,'""')}"`);csv.push(row.join(","))});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv.join("\n"));a.download="passbook_export.csv";a.click();showToast("Passbook exported!")});
        ["income","expense"].forEach(type=>{document.getElementById(`search-${type}`).addEventListener("input",function(){const searchTerm=this.value.toLowerCase();document.querySelectorAll(`#manage-${type}-table tbody tr`).forEach(row=>{row.style.display=row.cells[1].textContent.toLowerCase().includes(searchTerm)?"":"none"})})});
        
    </script>
</body>
</html>
