<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerebrexia Final Pro - Finance Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrAfter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isSameOrBefore.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_isBetween);
        dayjs.extend(window.dayjs_plugin_isSameOrAfter);
        dayjs.extend(window.dayjs_plugin_isSameOrBefore);
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
    
    <style>
        :root {
            --primary-bg: #f4f7f6; --secondary-bg: #e8ecef; --card-bg: #ffffff;
            --primary-accent: #005A9C; --text-primary: #121212; --text-secondary: #555;
            --border-color: #ddd; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --font-body: 'Roboto', sans-serif; --font-header: 'Poppins', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background-color: var(--primary-bg); color: var(--text-primary); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform 0.3s; }
        .overlay.show .modal-content { transform: scale(1); }
        .loader-container { position: fixed; top: 20px; right: 20px; z-index: 2001; background-color: var(--primary-accent); color: white; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); opacity: 0; transition: opacity .3s; }
        .loader-container.show { opacity: 1; }
        .mini-loader { border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; width: 100%; }
        nav { display: flex; flex-wrap: wrap; justify-content: center; background-color: var(--card-bg); border-radius: 10px; margin-bottom: 30px; padding: 10px; box-shadow: var(--shadow); }
        nav button { background: none; border: none; padding: 15px 25px; font-size: 1rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-radius: 8px; transition: background-color .3s, color .3s; display: flex; align-items: center; gap: 8px; }
        nav button:hover { background-color: var(--secondary-bg); }
        nav button.active { background-color: var(--primary-accent); color: white; font-weight: 700; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1, h2, h3 { font-family: var(--font-header); }
        .section-title { font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-accent); display: flex; align-items: center; gap: 12px; }
        .section-subtitle { font-size: 1.5rem; margin-bottom: 15px; color: var(--text-primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-accent); }
        .card h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px; font-weight: 500; }
        .card .amount { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .card .comparison { font-size: 0.9rem; color: var(--text-secondary); }
        .card.income { border-left-color: var(--success-color); }
        .card.expense { border-left-color: var(--danger-color); }
        .card.expected { border-left-color: var(--warning-color); }
        .card.info { border-left-color: var(--info-color); }
        .section-box { background-color: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: var(--shadow); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .form { display: flex; flex-direction: column; gap: 15px; }
        .form input, .form select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .form button { padding: 12px; border: none; border-radius: 5px; color: white; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color .3s; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .95rem; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 500; color: var(--text-secondary); background-color: #f9fafb; }
        .action-btn { background: var(--primary-accent); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: .9rem; margin-right: 5px; display: inline-flex; align-items: center; gap: 5px; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 5px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,.2); opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; }
        .filter-controls input, .filter-controls select, .filter-controls button { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .progress-bar { width: 100%; background-color: var(--secondary-bg); border-radius: 5px; overflow: hidden; height: 22px; }
        .progress-bar-fill { height: 100%; background-color: var(--primary-accent); text-align: right; color: white; padding: 0 8px; line-height: 22px; font-size: .8rem; white-space: nowrap; transition: width .5s ease-out; }
        .category-badge { background-color: var(--secondary-bg); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
        .search-bar { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px; font-size: 1rem; }
    </style>
</head>
<body>
    <div id="loader-container" class="loader-container"><div class="mini-loader"></div><span>Loading Dashboard...</span></div>
    
    <div id="modal-container"></div>

    <div id="app-container" class="container">
        <nav>
            <button class="nav-btn active" data-page="dashboard"><i class="fas fa-chart-line"></i>Dashboard</button>
            <button class="nav-btn" data-page="summary"><i class="fas fa-chart-pie"></i>Summary</button>
            <button class="nav-btn" data-page="expected_funds"><i class="fas fa-wallet"></i>Expected Funds</button>
            <button class="nav-btn" data-page="budgets"><i class="fas fa-bullseye"></i>Budgets</button>
            <button class="nav-btn" data-page="passbook"><i class="fas fa-book"></i>Passbook</button>
            <button class="nav-btn" data-page="manage_data"><i class="fas fa-edit"></i>Manage Data</button>
            <button id="sync-button" class="nav-btn" style="background-color: var(--info-color); color: white;" title="Sync data from automated sources via Cloud Function"><i class="fas fa-sync-alt"></i>Sync Automated</button>
        </nav>

        <main>
            <div id="page-dashboard" class="page active">
                <h2 class="section-title">Financial Overview</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <div class="card income"><h3>Total Income</h3><p class="amount" id="total-income">â‚¹0</p></div>
                    <div class="card expense"><h3>Total Expenses</h3><p class="amount" id="total-expenses">â‚¹0</p></div>
                    <div class="card"><h3>Net Balance</h3><p class="amount" id="net-remaining">â‚¹0</p></div>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="card info"><h3>Cash Flow (This Month)</h3><p class="amount" id="monthly-cashflow">â‚¹0</p><p class="comparison" id="monthly-cashflow-details">+â‚¹0 / -â‚¹0</p></div>
                    <div class="card warning"><h3>Avg. Daily Expense</h3><p class="amount" id="avg-daily-expense">â‚¹0</p><p class="comparison">(Last 30 days)</p></div>
                    <div class="card danger"><h3>Projected Runway</h3><p class="amount" id="runway-days">-- Days</p><p class="comparison">At current burn rate</p></div>
                </div>
                <div class="grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="section-box"><h3>Income Sources</h3><canvas id="income-doughnut-chart"></canvas></div>
                    <div class="section-box"><h3>Expense Categories</h3><canvas id="expense-pie-chart"></canvas></div>
                </div>
                <div class="section-box" style="grid-column: 1 / -1;">
                    <h3 class="section-subtitle">Balance Over Time</h3>
                    <canvas id="balance-line-chart"></canvas>
                </div>
            </div>
            <div id="page-summary" class="page">
                <h2 class="section-title">Financial Summary</h2>
                <div class="filter-controls section-box" style="margin-bottom: 20px;">
                    <label>Period:</label>
                   <select id="summary-period-filter">
						<option value="month">This Month</option>
						<option value="year">This Year</option> 
						<option value="week">This Week</option>
						<option value="last-month">Last Month</option>
						<option value="custom">Custom Range</option>
					</select>
                    <div id="summary-custom-range" style="display:none; gap: 15px;">
                        <input type="date" id="summary-start-date">
                        <input type="date" id="summary-end-date">
                    </div>
                    <button id="summary-apply-filter" class="action-btn">Apply</button>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                    <div class="card income"><h3>Income</h3><p class="amount" id="summary-income">â‚¹0</p><p class="comparison" id="summary-income-comp">vs previous period</p></div>
                    <div class="card expense"><h3>Expenses</h3><p class="amount" id="summary-expense">â‚¹0</p><p class="comparison" id="summary-expense-comp">vs previous period</p></div>
                    <div class="card"><h3>Net</h3><p class="amount" id="summary-net">â‚¹0</p><p class="comparison" id="summary-net-comp">vs previous period</p></div>
                </div>
                <div class="section-box">
                    <h3 class="section-subtitle">Category Breakdown</h3>
                    <div class="table-container"><table id="category-breakdown-table"></table></div>
                </div>
            </div>
            <div id="page-expected_funds" class="page">
                <h2 class="section-title">Expected Funds</h2>
                <div class="grid">
                    <div class="card expected"><h3>Total Expected</h3><p class="amount" id="total-expected">â‚¹0</p></div>
                    <div class="card income"><h3>Total Received</h3><p class="amount" id="total-received">â‚¹0</p></div>
                    <div class="card"><h3>Remaining</h3><p class="amount" id="total-remaining-expected">â‚¹0</p></div>
                </div>
                <div class="grid" style="grid-template-columns: 1fr 2fr;">
                    <div class="section-box">
                        <h3 class="section-subtitle">Add Expectation</h3>
                        <form id="expected-form" class="form">
                            <input type="text" id="expected-source" placeholder="Source (e.g., Sponsor)" required>
                            <input type="number" id="expected-amount" placeholder="Expected Amount" required>
                            <button type="submit" style="background-color: var(--warning-color); color: var(--text-primary);">Add Expectation</button>
                        </form>
                    </div>
                    <div class="section-box">
                        <h3 class="section-subtitle">Forecast List</h3>
                        <div class="table-container" style="max-height: 300px;">
                            <table id="expected-funds-table">
                                <thead><tr><th>Source</th><th>Expected</th><th>Received</th><th>Remaining</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-budgets" class="page">
                <h2 class="section-title">Budget Management</h2>
                <div class="grid" style="grid-template-columns: 1fr 2fr; align-items: flex-start;">
                    <div class="section-box">
                        <h3 class="section-subtitle">Add/Update Budget</h3>
                        <form id="add-budget-form" class="form">
                            <select id="budget-category" required>
                                <option value="" disabled selected>Select an Expense Category</option>
                            </select>
                            <input type="number" id="budget-amount" placeholder="Budget Amount" required>
                            <button type="submit" style="background-color: var(--primary-accent);">Set Budget</button>
                        </form>
                        <h3 class="section-subtitle" style="margin-top: 20px;">Defined Budgets</h3>
                        <div class="table-container" style="max-height: 250px;">
                            <table id="defined-budgets-table">
                                <thead><tr><th>Category</th><th>Amount</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="section-box">
                        <h3 class="section-subtitle">This Month's Spending vs Budget</h3>
                        <div id="budgets-container" class="grid" style="grid-template-columns: 1fr 1fr;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-passbook" class="page">
                <h2 class="section-title">Transaction Passbook</h2>
                <div class="section-box">
                    <div class="filter-controls">
                        <input type="date" id="start-date-filter">
                        <input type="date" id="end-date-filter">
                        <select id="category-filter"><option value="">All Categories</option></select>
                        <select id="type-filter"><option value="">All Types</option><option value="Income">Income</option><option value="Expense">Expense</option></select>
                        <button id="filter-btn" class="action-btn">Filter</button>
                        <button id="clear-filter-btn" class="action-btn" style="background-color: var(--text-secondary);">Clear</button>
                        <button id="export-csv-btn" class="action-btn" style="background-color: var(--success-color); margin-left: auto;">Export to CSV</button>
                    </div>
                    <div class="table-container">
                        <table id="passbook-table">
                            <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th>Amount</th><th>Balance</th><th>Receipt</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="page-manage_data" class="page">
                <h2 class="section-title">Add & Manage Manual Entries</h2>
                <div class="form-grid">
                    <div class="section-box">
                        <h3><i class="fas fa-plus-circle" style="color:var(--success-color)"></i> Add Income</h3>
                        <form id="income-form" class="form">
                            <input type="date" id="income-date" required>
                            <input type="text" id="income-desc" placeholder="Description" required>
                            <select id="income-category" required><option value="" disabled selected>Category</option><option>Sponsorship</option><option>Registration Fees</option><option>Batch Collection</option><option>Department Collection</option><option>Other</option></select>
                            <input type="number" step="0.01" id="income-amount" placeholder="Amount" required>
                            <button type="submit" style="background-color: var(--success-color);">Add Income</button>
                        </form>
                    </div>
                    <div class="section-box">
                        <h3><i class="fas fa-minus-circle" style="color:var(--danger-color)"></i> Add Expense</h3>
                        <form id="expense-form" class="form">
                            <input type="date" id="expense-date" required>
                            <input type="text" id="expense-desc" placeholder="Description" required>
                            
                            <select id="expense-category" required>
								<option value="" disabled selected>Category</option>
								<option value="Artist & Talent">Artist & Talent</option>
								<option value="Production">Production</option>
								<option value="Marketing">Marketing</option>
								<option value="Printing">Printing</option>
								<option value="Prizes">Prizes</option>
								<option value="Food & Catering">Food & Catering</option>
								<option value="Logistics">Logistics</option>
								<option value="Miscellaneous">Miscellaneous</option>
							</select>

                            <input type="number" step="0.01" id="expense-amount" placeholder="Amount" required>
                            <input type="file" id="receipt-upload" accept="image/*,application/pdf">
                            <button type="submit" style="background-color: var(--danger-color);">Add Expense</button>
                        </form>
                    </div>
                </div>
                <div class="section-box" style="margin-top: 30px;">
                    <h3 class="section-subtitle">Manage Income Entries</h3>
                    <input type="text" id="search-income" class="search-bar" placeholder="Search income entries...">
                    <div class="table-container"><table id="manage-income-table"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <div class="section-box" style="margin-top: 30px;">
                    <h3 class="section-subtitle">Manage Expense Entries</h3>
                    <input type="text" id="search-expense" class="search-bar" placeholder="Search expense entries...">
                    <div class="table-container"><table id="manage-expense-table"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // ===================================================================================
        // === ðŸš¨ IMPORTANT SETUP INSTRUCTIONS ðŸš¨ ==========================================
        // ===================================================================================
        
        // 1. ADD YOUR FIREBASE CONFIGURATION HERE
        const firebaseConfig = {
			apiKey: "AIzaSyD1ZKsLTqnAfD_SSU3iQ36pU3aG71DZKGk",
			authDomain: "expensetrackerpro-f5964.firebaseapp.com",
			projectId: "expensetrackerpro-f5964",
			storageBucket: "expensetrackerpro-f5964.appspot.com",
			messagingSenderId: "409195239506",
			appId: "1:409195239506:web:717208fd6d28687604a78b",
			measurementId: "G-0HTGG3S8EM"
		};

        // 2. SET YOUR FIRESTORE SECURITY RULES (IF YOU WANT NO LOGIN)
        /*
            rules_version = '2';
            service cloud.firestore {
              match /databases/{database}/documents {
                // WARNING: This allows ANYONE to read and write to your database.
                // This is NOT secure. Use only if you understand the risks.
                match /{document=**} {
                  allow read, write: if true;
                }
              }
            }
        */

        // 3. CREATE FIRESTORE INDEXES
        // Index 1: Collection 'transactions', Field 'date', Order 'Descending'
        // Index 2: Collection 'expectedPayments', Field 'createdAt', Order 'Descending'
        
        // 4. (NEW) GOOGLE SHEET CONFIGURATION
        const GOOGLE_API_KEY = 'AIzaSyBsf5q3I_HUMnuNC_Xel_cc6C29UYcO-Xs'; // Your Google Cloud API Key
        const SHEET_ID = '1tru8u40xpTHIkr7zYSFK79TSOz4fHHiTkG_6r-zi6CQ'; // The ID of your Google Sheet
        const SHEET_RANGE = "'22 BATCH'!E122"; // The specific cell you want to get (e.g., "'22 BATCH'!E122")

        // ===================================================================================
        // === APPLICATION CODE ==============================================================
        // ===================================================================================

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();

        // --- GLOBAL STATE & UI ELEMENTS ---
        const state = {
            transactions: [],
            batchTransactions: [], // For Google Sheet data
            expected: [],
            budgets: {},
            isLoading: false,
        };
        let chartInstances = {};
        const loader = document.getElementById('loader-container');
        const appContainer = document.getElementById('app-container');

        // --- HELPER FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(amount || 0);
        const todayISO = () => new Date().toISOString().split('T')[0];
        const formatDateForInput = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toISOString().split('T')[0];
        };
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container') || document.body.appendChild(Object.assign(document.createElement('div'), { id: 'toast-container' }));
            const toast = Object.assign(document.createElement('div'), {
                className: `toast`,
                style: `background-color: ${type === 'error' ? 'var(--danger-color)' : 'var(--success-color)'}`,
                textContent: message
            });
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };
        const setLoading = (isLoading, text = 'Working...') => {
            state.isLoading = isLoading;
            loader.querySelector('span').textContent = text;
            loader.classList.toggle('show', isLoading);
        };
        
        // --- DATA FETCHING & REAL-TIME LISTENERS ---
        async function fetchSheetData() {
            if (!GOOGLE_API_KEY || !SHEET_ID || !SHEET_RANGE) return;
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(SHEET_RANGE)}?key=${GOOGLE_API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch sheet data. Check API key and Sheet ID.');
                const data = await response.json();
                if (!data.values || !data.values[0] || !data.values[0][0]) return;
                
                const totalAmount = parseFloat(data.values[0][0].replace(/[^0-9.-]+/g,""));
                if (isNaN(totalAmount)) return;

                state.batchTransactions = [{
                    id: 'sheet-total-batch',
                    date: todayISO(), // Sets the date to today
                    description: 'MBBS 22 BATCH',
                    amount: totalAmount,
                    type: 'Income',
                    category: 'Batch Collection',
                    isSheet: true, // Custom flag to identify this transaction
                }];
            } catch (error) {
                console.error("Error fetching Google Sheet data:", error);
                showToast(error.message, "error");
            }
        }

        function setupRealtimeListeners() {
            setLoading(true, 'Fetching data...');

            db.collection("transactions").orderBy("date", "desc").onSnapshot(snapshot => {
                state.transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date ? formatDateForInput(doc.data().date) : todayISO(),
                }));
                renderAll(); // Re-render with new data from Firestore
                setLoading(false);
            }, error => {
                console.error("Error fetching transactions: ", error);
                showToast("Error: Could not fetch transactions. Check Firestore rules and indexes.", "error");
                setLoading(false);
            });

            db.collection("expectedPayments").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                state.expected = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id, source: data.source,
                        expectedAmount: data.expectedAmount,
                        receivedAmount: data.receivedAmount || 0,
                    };
                });
                renderAll();
            }, error => console.error("Error fetching expected payments: ", error));

            db.collection("budgets").onSnapshot(snapshot => {
                state.budgets = snapshot.docs.reduce((acc, doc) => {
                    acc[doc.id] = doc.data().budgetAmount;
                    return acc;
                }, {});
                renderAll();
            }, error => console.error("Error fetching budgets: ", error));
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            const allTransactions = [...state.transactions, ...state.batchTransactions];
            const activePageId = document.querySelector('.page.active')?.id;
            if (!activePageId) return;

            switch(activePageId) {
                case 'page-dashboard': renderDashboard(allTransactions); break;
                case 'page-summary': updateSummaryPage(allTransactions); break;
                case 'page-expected_funds': renderExpectedFunds(state.expected); break;
                case 'page-budgets': 
                    populateBudgetCategoryDropdown();
                    renderBudgets(allTransactions, state.budgets); 
                    break;
                case 'page-passbook': 
                    populateFilterDropdowns(allTransactions);
                    renderPassbook(allTransactions);
                    break;
                case 'page-manage_data': 
                    // IMPORTANT: Manage data page ONLY shows Firestore data that can be edited/deleted
                    renderManageDataTables(state.transactions); 
                    break;
            }
        }

        function renderDashboard(data) {
            const income = data.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0);
            const expenses = data.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expenses').textContent = formatCurrency(expenses);
            document.getElementById('net-remaining').textContent = formatCurrency(income - expenses);
            
            const thisMonthTxns = data.filter(t => dayjs(t.date).isSame(dayjs(), 'month'));
            const monthlyIncome = thisMonthTxns.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0);
            const monthlyExpense = thisMonthTxns.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('monthly-cashflow').textContent = formatCurrency(monthlyIncome - monthlyExpense);
            document.getElementById('monthly-cashflow-details').textContent = `+${formatCurrency(monthlyIncome)} / ${formatCurrency(monthlyExpense)}`;

            const last30DaysExpenses = data
                .filter(t => t.type === 'Expense' && dayjs(t.date).isAfter(dayjs().subtract(30, 'day')))
                .reduce((s, t) => s + t.amount, 0);
            const avgDailyExpense = last30DaysExpenses > 0 ? last30DaysExpenses / 30 : 0;
            document.getElementById('avg-daily-expense').textContent = formatCurrency(avgDailyExpense);

            const runwayDays = avgDailyExpense > 0 ? Math.floor((income - expenses) / avgDailyExpense) : Infinity;
            document.getElementById('runway-days').textContent = isFinite(runwayDays) ? `${runwayDays} Days` : 'âˆž Days';

            updateDashboardCharts(data);
            renderBalanceChart(data);
        }
        
        function updateDashboardCharts(data) {
            if (chartInstances['incomeDoughnut']) chartInstances['incomeDoughnut'].destroy();
            if (chartInstances['expensePie']) chartInstances['expensePie'].destroy();
            
            const incomeCategories = data.filter(t => t.type === 'Income').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const expenseCategories = data.filter(t => t.type === 'Expense').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const getChartColors = (count) => {
                const colors = ['#005A9C', '#4CAF50', '#FFC107', '#E91E63', '#9C27B0', '#2196F3', '#FF9800', '#795548', '#607D8B', '#00BCD4'];
                return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
            };

            if(Object.keys(incomeCategories).length > 0) {
                 const incomeCtx = document.getElementById('income-doughnut-chart').getContext('2d');
                chartInstances['incomeDoughnut'] = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(incomeCategories),
                        datasets: [{ data: Object.values(incomeCategories), backgroundColor: getChartColors(Object.keys(incomeCategories).length) }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: false } } }
                });
            }

            if(Object.keys(expenseCategories).length > 0) {
                 const expenseCtx = document.getElementById('expense-pie-chart').getContext('2d');
                chartInstances['expensePie'] = new Chart(expenseCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(expenseCategories),
                        datasets: [{ data: Object.values(expenseCategories), backgroundColor: getChartColors(Object.keys(expenseCategories).length) }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: false } } }
                });
            }
        }

        function renderBalanceChart(transactions) {
            if (chartInstances['balanceLine']) chartInstances['balanceLine'].destroy();

            const sortedTxns = [...transactions].sort((a, b) => dayjs(a.date).diff(dayjs(b.date)));
            let currentBalance = 0;
            const chartData = [];

            sortedTxns.forEach(txn => {
                currentBalance += (txn.type === 'Income' ? txn.amount : -txn.amount);
                chartData.push({ x: txn.date, y: currentBalance });
            });
            
            const dailyBalances = chartData.reduce((acc, dataPoint) => {
                acc[dataPoint.x] = dataPoint.y; // Keep the last balance for each day
                return acc;
            }, {});

            const labels = Object.keys(dailyBalances).sort((a,b) => dayjs(a).diff(dayjs(b)));
            const dataPoints = labels.map(label => dailyBalances[label]);

            const ctx = document.getElementById('balance-line-chart').getContext('2d');
            chartInstances['balanceLine'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Balance',
                        data: dataPoints,
                        borderColor: 'var(--primary-accent)',
                        backgroundColor: 'rgba(0, 90, 156, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { ticks: { callback: (value) => formatCurrency(value) } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateSummaryPage(transactions) {
            const periodFilter = document.getElementById('summary-period-filter').value;
            let start, end, pStart, pEnd;
            const now = dayjs();
            
            if (periodFilter === 'year') {
                start = now.startOf('year');
                end = now.endOf('year');
                pStart = start.subtract(1, 'year');
                pEnd = end.subtract(1, 'year');
            } else if (periodFilter === 'week') {
                start = now.startOf('week'); end = now.endOf('week');
                pStart = start.subtract(1, 'week'); pEnd = end.subtract(1, 'week');
            } else if (periodFilter === 'last-month') {
                start = now.subtract(1, 'month').startOf('month'); end = now.subtract(1, 'month').endOf('month');
                pStart = start.subtract(1, 'month'); pEnd = end.subtract(1, 'month');
            } else if (periodFilter === 'custom') {
                start = dayjs(document.getElementById('summary-start-date').value); 
                end = dayjs(document.getElementById('summary-end-date').value);
                const diff = end.diff(start, 'day');
                pStart = start.subtract(diff + 1, 'day'); pEnd = end.subtract(diff + 1, 'day');
            } else { // Default to month
                start = now.startOf('month'); end = now.endOf('month');
                pStart = start.subtract(1, 'month'); pEnd = end.subtract(1, 'month');
            }

            const currentPeriodTxns = transactions.filter(t => dayjs(t.date).isBetween(start, end, null, '[]'));
            const prevPeriodTxns = transactions.filter(t => dayjs(t.date).isBetween(pStart, pEnd, null, '[]'));
            
            const calculateMetrics = (txns) => ({
                income: txns.filter(t => t.type === 'Income').reduce((s, t) => s + t.amount, 0),
                expense: txns.filter(t => t.type === 'Expense').reduce((s, t) => s + t.amount, 0),
            });

            const currentMetrics = calculateMetrics(currentPeriodTxns); currentMetrics.net = currentMetrics.income - currentMetrics.expense;
            const prevMetrics = calculateMetrics(prevPeriodTxns); prevMetrics.net = prevMetrics.income - prevMetrics.expense;
            
            const formatComp = (current, previous) => {
                if (previous === 0) return current > 0 ? `(â†‘)` : ``;
                const percentChange = ((current - previous) / Math.abs(previous)) * 100;
                return `<span style="color:${percentChange >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">(${percentChange >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(percentChange).toFixed(1)}%)</span> vs prev. period`;
            };
            
            document.getElementById('summary-income').textContent = formatCurrency(currentMetrics.income);
            document.getElementById('summary-income-comp').innerHTML = formatComp(currentMetrics.income, prevMetrics.income);
            document.getElementById('summary-expense').textContent = formatCurrency(currentMetrics.expense);
            document.getElementById('summary-expense-comp').innerHTML = formatComp(currentMetrics.expense, prevMetrics.expense);
            document.getElementById('summary-net').textContent = formatCurrency(currentMetrics.net);
            document.getElementById('summary-net-comp').innerHTML = formatComp(currentMetrics.net, prevMetrics.net);
            
            renderCategoryBreakdown(currentPeriodTxns, prevPeriodTxns);
        }

        function renderCategoryBreakdown(currentTxns, prevTxns) {
            const table = document.getElementById('category-breakdown-table');
            const getCategoryTotals = (txns) => txns.reduce((acc, t) => {
                if (!acc[t.category]) acc[t.category] = { income: 0, expense: 0 };
                acc[t.category][t.type.toLowerCase()] += t.amount;
                return acc;
            }, {});

            const currentCategoryTotals = getCategoryTotals(currentTxns);
            const prevCategoryTotals = getCategoryTotals(prevTxns);
            const totalCurrentExpense = Object.values(currentCategoryTotals).reduce((sum, cat) => sum + cat.expense, 0);
            const allCategories = [...new Set([...Object.keys(currentCategoryTotals), ...Object.keys(prevCategoryTotals)])];

            let tableHTML = '<thead><tr><th>Category</th><th>Type</th><th>Amount</th><th>% of Total Expense</th><th>Change vs Prev.</th></tr></thead><tbody>';
            for(const category of allCategories.sort()) {
                const current = currentCategoryTotals[category] || { income: 0, expense: 0 };
                const previous = prevCategoryTotals[category] || { income: 0, expense: 0 };
                if (current.income > 0) {
                    const change = current.income - previous.income;
                    tableHTML += `<tr><td>${category}</td><td><span class="category-badge" style="background-color:#d4edda; color:#155724;">Income</span></td><td>${formatCurrency(current.income)}</td><td>-</td><td style="color:${change >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${change >= 0 ? '+' : ''}${formatCurrency(change)}</td></tr>`;
                }
                if (current.expense > 0) {
                    const change = current.expense - previous.expense;
                    const percentOfTotal = totalCurrentExpense > 0 ? (current.expense / totalCurrentExpense * 100).toFixed(1) + '%' : '0%';
                    tableHTML += `<tr><td>${category}</td><td><span class="category-badge" style="background-color:#f8d7da; color:#721c24;">Expense</span></td><td>${formatCurrency(current.expense)}</td><td>${percentOfTotal}</td><td style="color:${change <= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${change >= 0 ? '+' : ''}${formatCurrency(change)}</td></tr>`;
                }
            }
            table.innerHTML = tableHTML + '</tbody>';
        }

        function renderExpectedFunds(data) {
            const totalExpected = data.reduce((s, t) => s + t.expectedAmount, 0);
            const totalReceived = data.reduce((s, t) => s + t.receivedAmount, 0);
            document.getElementById('total-expected').textContent = formatCurrency(totalExpected);
            document.getElementById('total-received').textContent = formatCurrency(totalReceived);
            document.getElementById('total-remaining-expected').textContent = formatCurrency(totalExpected - totalReceived);
            
            const tbody = document.querySelector("#expected-funds-table tbody");
            tbody.innerHTML = data.map(item => {
                const remaining = item.expectedAmount - item.receivedAmount;
                return `<tr><td>${item.source}</td><td>${formatCurrency(item.expectedAmount)}</td><td>${formatCurrency(item.receivedAmount)}</td><td>${formatCurrency(remaining)}</td><td>${remaining > 0 ? `<button class="action-btn" data-id="${item.id}" data-action="receive" style="background-color: var(--success-color);">Receive</button>` : 'Completed'}</td></tr>`;
            }).join('') || `<tr><td colspan="5">No expected funds added.</td></tr>`;

            tbody.querySelectorAll('button[data-action="receive"]').forEach(button => {
                button.onclick = (e) => openReceiveExpectedModal(e.target.dataset.id);
            });
        }

        function renderBudgets(transactions, budgets) {
            const budgetsContainer = document.getElementById('budgets-container');
            const definedBudgetsTbody = document.querySelector("#defined-budgets-table tbody");
            budgetsContainer.innerHTML = '';
            definedBudgetsTbody.innerHTML = '';

            if (Object.keys(budgets).length > 0) {
                for (const category in budgets) {
                    definedBudgetsTbody.innerHTML += `
                        <tr>
                            <td>${category}</td>
                            <td>${formatCurrency(budgets[category])}</td>
                            <td><button class="action-btn" data-category="${category}" data-action="delete-budget" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i></button></td>
                        </tr>`;
                }
            } else {
                definedBudgetsTbody.innerHTML = '<tr><td colspan="3">No budgets set.</td></tr>';
            }
            
            document.querySelectorAll('button[data-action="delete-budget"]').forEach(button => {
                button.onclick = (e) => deleteBudget(e.currentTarget.dataset.category);
            });

            const currentMonthExpenses = transactions
                .filter(t => t.type === 'Expense' && dayjs(t.date).isSame(dayjs(), 'month'))
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            if (Object.keys(budgets).length > 0) {
                for (const category in budgets) {
                    const budgetAmount = parseFloat(budgets[category]);
                    const spentAmount = currentMonthExpenses[category] || 0;
                    const percentage = budgetAmount > 0 ? (spentAmount / budgetAmount) * 100 : 0;
                    let progressBarColor = 'var(--success-color)';
                    if (percentage > 75 && percentage <= 100) progressBarColor = 'var(--warning-color)';
                    else if (percentage > 100) progressBarColor = 'var(--danger-color)';
                    
                    const budgetCard = document.createElement('div');
                    budgetCard.className = 'card info';
                    budgetCard.innerHTML = `<h3>${category}</h3><p>Spent ${formatCurrency(spentAmount)} of ${formatCurrency(budgetAmount)}</p><div class="progress-bar" style="margin-top: 10px;"><div class="progress-bar-fill" style="width: ${Math.min(100, percentage)}%; background-color: ${progressBarColor};">${percentage.toFixed(0)}%</div></div>`;
                    budgetsContainer.appendChild(budgetCard);
                }
            } else {
                budgetsContainer.innerHTML = '<p>No budgets defined. Use the form on the left to add one.</p>';
            }
        }
        
        function renderPassbook(data) {
            const tableBody = document.querySelector("#passbook-table tbody");
            tableBody.innerHTML = '';
            let currentBalance = 0;
            const sortedData = [...data].sort((a, b) => dayjs(a.date).diff(dayjs(b.date)));
            const reversedData = sortedData.slice().reverse(); // Show newest first in table

            const balanceMap = new Map();
            sortedData.forEach(item => {
                currentBalance += (item.type === 'Income' ? item.amount : -item.amount);
                balanceMap.set(item.id, currentBalance);
            });

            tableBody.innerHTML = reversedData.map(item => {
                const receiptCell = item.isSheet 
                    ? 'From Google Sheet' 
                    : (item.receiptUrl ? `<a href="${item.receiptUrl}" target="_blank" class="action-btn" style="background-color:var(--info-color);"><i class="fas fa-receipt"></i> View</a>` : 'N/A');
                
                return `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.description}</td>
                    <td><span class="category-badge" style="background-color: ${item.type === 'Income' ? '#d4edda' : '#f8d7da'}; color: ${item.type === 'Income' ? '#155724' : '#721c24'};">${item.category}</span></td>
                    <td style="color: ${item.type === 'Income' ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 500;">${item.type}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${formatCurrency(balanceMap.get(item.id))}</td>
                    <td>${receiptCell}</td>
                </tr>`
            }).join('') || `<tr><td colspan="7">No transactions found.</td></tr>`;
        }
        
        function renderManageDataTables(transactions) {
            const incomeTableBody = document.querySelector("#manage-income-table tbody");
            const expenseTableBody = document.querySelector("#manage-expense-table tbody");
            incomeTableBody.innerHTML = '';
            expenseTableBody.innerHTML = '';
            const incomes = transactions.filter(t => t.type === 'Income');
            const expenses = transactions.filter(t => t.type === 'Expense');

            incomes.forEach(item => {
                incomeTableBody.innerHTML += `<tr><td>${item.date}</td><td>${item.description}</td><td>${formatCurrency(item.amount)}</td><td><button class="action-btn" data-id="${item.id}" data-type="Income" data-action="edit"><i class="fas fa-edit"></i> Edit</button><button class="action-btn" data-id="${item.id}" data-type="Income" data-action="delete" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i> Delete</button></td></tr>`;
            });
            expenses.forEach(item => {
                expenseTableBody.innerHTML += `<tr><td>${item.date}</td><td>${item.description}</td><td>${formatCurrency(item.amount)}</td><td>${item.receiptUrl ? `<a href="${item.receiptUrl}" target="_blank" class="action-btn" style="background-color:var(--info-color);"><i class="fas fa-receipt"></i></a>` : ''}<button class="action-btn" data-id="${item.id}" data-type="Expense" data-action="edit"><i class="fas fa-edit"></i> Edit</button><button class="action-btn" data-id="${item.id}" data-type="Expense" data-action="delete" style="background-color:var(--danger-color);"><i class="fas fa-trash-alt"></i> Delete</button></td></tr>`;
            });

            document.querySelectorAll('#manage-income-table button, #manage-expense-table button').forEach(button => {
                button.onclick = (e) => {
                    const { id, type, action } = e.currentTarget.dataset;
                    if (action === 'edit') openEditModal(id, type);
                    else if (action === 'delete') deleteEntry(id, type);
                };
            });
        }

        function populateFilterDropdowns(transactions) {
            const categoryFilter = document.getElementById('category-filter');
            const uniqueCategories = [...new Set(transactions.map(t => t.category))].sort();
            const currentVal = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            uniqueCategories.forEach(cat => categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`);
            categoryFilter.value = currentVal;
        }

        function populateBudgetCategoryDropdown() {
            const budgetCategorySelect = document.getElementById('budget-category');
            const expenseCategorySelect = document.getElementById('expense-category');
            const categories = [...expenseCategorySelect.options].map(opt => opt.value).filter(val => val);
            const currentVal = budgetCategorySelect.value;
            budgetCategorySelect.innerHTML = '<option value="" disabled selected>Select an Expense Category</option>';
            categories.forEach(cat => budgetCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
            budgetCategorySelect.value = currentVal;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            setLoading(true, 'Loading Data...');
            // Fetch sheet data first
            await fetchSheetData();
            // Then set up Firebase listeners
            setupRealtimeListeners();
            
            document.getElementById('income-date').value = todayISO();
            document.getElementById('expense-date').value = todayISO();
        });
        
        // --- FORM SUBMISSIONS ---
        async function submitTransaction(formType, payload) {
            setLoading(true);
            try {
                let receiptUrl = '';
                if (payload.receiptFile) {
                    const storageRef = storage.ref(`receipts/${Date.now()}_${payload.receiptFile.name}`);
                    const snapshot = await storageRef.put(payload.receiptFile);
                    receiptUrl = await snapshot.ref.getDownloadURL();
                }

                await db.collection("transactions").add({
                    date: firebase.firestore.Timestamp.fromDate(new Date(payload.date)),
                    type: payload.type,
                    description: payload.description,
                    category: payload.category,
                    amount: payload.amount,
                    receiptUrl: receiptUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast(`${payload.type} added successfully!`, 'success');
                document.getElementById(`${formType}-form`).reset();
                document.getElementById(`${formType}-date`).value = todayISO();
            } catch (error) {
                console.error(`Error adding ${payload.type}:`, error);
                showToast(`Error adding entry: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        document.getElementById('income-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitTransaction('income', {
                type: 'Income',
                date: document.getElementById('income-date').value,
                description: document.getElementById('income-desc').value,
                category: document.getElementById('income-category').value,
                amount: parseFloat(document.getElementById('income-amount').value)
            });
        });

        document.getElementById('expense-form').addEventListener('submit', (e) => {
            e.preventDefault();
            submitTransaction('expense', {
                type: 'Expense',
                date: document.getElementById('expense-date').value,
                description: document.getElementById('expense-desc').value,
                category: document.getElementById('expense-category').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                receiptFile: document.getElementById('receipt-upload').files[0]
            });
        });

        document.getElementById('expected-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            const source = document.getElementById('expected-source').value;
            const amount = parseFloat(document.getElementById('expected-amount').value);
            try {
                await db.collection("expectedPayments").add({
                    source: source,
                    expectedAmount: amount,
                    receivedAmount: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Expected fund added!', 'success');
                e.target.reset();
            } catch (error) {
                showToast(`Error adding expected fund: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });
        
        document.getElementById('add-budget-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            
            if (!category || isNaN(amount) || amount <= 0) {
                showToast('Please select a category and enter a valid positive amount.', 'error');
                return;
            }
            
            setLoading(true);
            try {
                await db.collection("budgets").doc(category).set({ budgetAmount: amount });
                showToast(`Budget for ${category} has been set/updated!`, 'success');
                e.target.reset();
            } catch (error) {
                showToast(`Error setting budget: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });
        
        // --- MODAL & DATA ACTIONS ---
        const modalContainer = document.getElementById('modal-container');
        function openModal(title, contentHTML) {
            modalContainer.innerHTML = `<div class="overlay show"><div class="modal-content"><h2 class="section-title">${title}</h2>${contentHTML}<button class="action-btn" style="background-color: var(--text-secondary); margin-top: 20px;" onclick="window.closeModal()">Close</button></div></div>`;
        }
        window.closeModal = () => { modalContainer.innerHTML = ''; };

        function openEditModal(id, type) {
            const item = state.transactions.find(t => t.id === id);
            if (!item) return;

            const categories = type === 'Income' 
                ? [...document.getElementById('income-category').options].map(o=>o.value).filter(Boolean) 
                : [...document.getElementById('expense-category').options].map(o=>o.value).filter(Boolean);

            const contentHTML = `
                <form id="edit-form" class="form">
                    <input type="date" id="edit-date" value="${item.date}" required>
                    <input type="text" id="edit-desc" placeholder="Description" value="${item.description}" required>
                    <select id="edit-category" required>${categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}</select>
                    <input type="number" step="0.01" id="edit-amount" placeholder="Amount" value="${item.amount}" required>
                    ${item.receiptUrl ? `<p>Current: <a href="${item.receiptUrl}" target="_blank">View Receipt</a></p>` : ''}
                    <label>Upload New Receipt (optional):</label><input type="file" id="edit-receipt" accept="image/*,application/pdf">
                    <button type="submit" class="action-btn">Save Changes</button>
                </form>`;
            openModal(`Edit ${type} Entry`, contentHTML);

            document.getElementById('edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const newReceiptFile = document.getElementById('edit-receipt').files[0];
                    let receiptUrlToUpdate = item.receiptUrl;

                    if (newReceiptFile) {
                        const storageRef = storage.ref(`receipts/${Date.now()}_${newReceiptFile.name}`);
                        const snapshot = await storageRef.put(newReceiptFile);
                        receiptUrlToUpdate = await snapshot.ref.getDownloadURL();
                    }

                    await db.collection("transactions").doc(id).update({
                        date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('edit-date').value)),
                        description: document.getElementById('edit-desc').value,
                        category: document.getElementById('edit-category').value,
                        amount: parseFloat(document.getElementById('edit-amount').value),
                        receiptUrl: receiptUrlToUpdate,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Entry updated!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Update failed: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            });
        }
        
        function openReceiveExpectedModal(id) {
            const item = state.expected.find(e => e.id === id);
            if (!item) return;
            const contentHTML = `
                <form id="receive-expected-form" class="form">
                    <p><strong>Source:</strong> ${item.source}</p>
                    <p><strong>Remaining:</strong> ${formatCurrency(item.expectedAmount - item.receivedAmount)}</p>
                    <input type="number" step="0.01" id="receive-amount" placeholder="Amount to Receive" required max="${item.expectedAmount - item.receivedAmount}" value="${item.expectedAmount - item.receivedAmount}">
                    <input type="date" id="receive-date" value="${todayISO()}" required>
                    <button type="submit" class="action-btn" style="background-color: var(--success-color);">Mark as Received</button>
                </form>`;
            openModal('Receive Expected Funds', contentHTML);

            document.getElementById('receive-expected-form').addEventListener('submit', async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    const receiveAmount = parseFloat(document.getElementById('receive-amount').value);
                    const newTotalReceived = item.receivedAmount + receiveAmount;
                    
                    await db.collection("expectedPayments").doc(id).update({ receivedAmount: newTotalReceived });
                    await db.collection("transactions").add({
                        date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('receive-date').value)),
                        type: 'Income',
                        description: `Funds received from ${item.source}`,
                        category: 'Sponsorship', // Or a more suitable category
                        amount: receiveAmount,
                        receiptUrl: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Funds received!', 'success');
                    closeModal();
                } catch (error) {
                    showToast(`Error receiving funds: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            });
        }

        async function deleteEntry(id, type) {
            if (confirm(`Are you sure you want to delete this ${type} entry? This cannot be undone.`)) {
                setLoading(true);
                try {
                    const docRef = db.collection("transactions").doc(id);
                    const doc = await docRef.get();
                    if (doc.exists && doc.data().receiptUrl) {
                        await storage.refFromURL(doc.data().receiptUrl).delete().catch(err => {
                             if (err.code !== 'storage/object-not-found') throw err;
                        });
                    }
                    await docRef.delete();
                    showToast('Entry deleted successfully!', 'success');
                } catch (error) {
                    showToast(`Error deleting entry: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            }
        }
        
        async function deleteBudget(category) {
             if (confirm(`Are you sure you want to delete the budget for "${category}"?`)) {
                setLoading(true);
                try {
                    await db.collection("budgets").doc(category).delete();
                    showToast(`Budget for "${category}" deleted.`, 'success');
                } catch (error) {
                    showToast(`Error deleting budget: ${error.message}`, 'error');
                } finally {
                    setLoading(false);
                }
            }
        }

        // --- NAVIGATION & FILTERS ---
        document.querySelectorAll(".nav-btn").forEach(button=>{button.addEventListener("click",function(){if(this.id==="sync-button")return;document.querySelectorAll(".nav-btn").forEach(btn=>btn.classList.remove("active"));this.classList.add("active");document.querySelectorAll(".page").forEach(page=>page.classList.remove("active"));document.getElementById(`page-${this.dataset.page}`).classList.add("active");renderAll()})});
        document.getElementById("summary-period-filter").addEventListener("change",function(){document.getElementById("summary-custom-range").style.display=this.value==="custom"?"flex":"none"});
        document.getElementById("summary-apply-filter").addEventListener("click",() => updateSummaryPage([...state.transactions, ...state.batchTransactions]));
        document.getElementById("filter-btn").addEventListener("click",function(){
            const startDate=document.getElementById("start-date-filter").value;
            const endDate=document.getElementById("end-date-filter").value;
            const category=document.getElementById("category-filter").value;
            const type=document.getElementById("type-filter").value;
            let filtered=[...state.transactions, ...state.batchTransactions];
            if(startDate)filtered=filtered.filter(t=>dayjs(t.date).isSameOrAfter(dayjs(startDate)));
            if(endDate)filtered=filtered.filter(t=>dayjs(t.date).isSameOrBefore(dayjs(endDate)));
            if(category)filtered=filtered.filter(t=>t.category===category);
            if(type)filtered=filtered.filter(t=>t.type===type);
            renderPassbook(filtered)
        });
        document.getElementById("clear-filter-btn").addEventListener("click",()=>{
            document.getElementById("start-date-filter").value="";
            document.getElementById("end-date-filter").value="";
            document.getElementById("category-filter").value="";
            document.getElementById("type-filter").value="";
            renderPassbook([...state.transactions, ...state.batchTransactions])
        });
        document.getElementById("export-csv-btn").addEventListener("click",()=>{const table=document.getElementById("passbook-table");let csv=[[...table.querySelectorAll("thead th")].map(th=>`"${th.innerText}"`).join(",")];table.querySelectorAll("tbody tr").forEach(tr=>{let row=[...tr.querySelectorAll("td")].map(td=>`"${td.innerText.replace(/"/g,'""')}"`);csv.push(row.join(","))});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv.join("\n"));a.download="passbook_export.csv";a.click();showToast("Passbook exported!")});
        ["income","expense"].forEach(type=>{document.getElementById(`search-${type}`).addEventListener("input",function(){const searchTerm=this.value.toLowerCase();document.querySelectorAll(`#manage-${type}-table tbody tr`).forEach(row=>{row.style.display=row.cells[1].textContent.toLowerCase().includes(searchTerm)?"":"none"})})});
        document.getElementById("sync-button").addEventListener("click",async()=>{if(!confirm("Run automated sync? This calls a Firebase Cloud Function to import data."))return;setLoading(true);try{const syncSheetData=functions.httpsCallable("syncAutomatedEntries");const result=await syncSheetData();showToast(`Sync complete: ${result.data.message}`,"success")}catch(error){console.error("Error calling sync function:",error);showToast(`Sync failed: ${error.message}`,"error")}finally{setLoading(false)}});
    </script>
</body>
</html>